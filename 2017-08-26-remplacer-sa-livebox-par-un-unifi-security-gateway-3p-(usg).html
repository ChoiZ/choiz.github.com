<!DOCTYPE html>
<html lang="fr">
<head>
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="//www.choiz.fr/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="//www.choiz.fr/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="//www.choiz.fr/theme/css/font-awesome.min.css">
  <link href="//www.choiz.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ChoiZ Atom">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
<meta name="author" content="choiz" />
<meta name="description" content="Ayant pas mal utilisé le materiel d'ubiquiti j'ai acheté un USG 3 pour la maison. En recherchant un peu sur le net j'ai vu qu'il était possible de remplacer la livebox par l'USG tout en concervant la télévision etc… grâce a des VLANs. Il y a pas mal de manipulations …" />
<meta name="keywords" content="UniFi, Gateway, Livebox, USG, Network">
<meta property="og:site_name" content="ChoiZ"/>
<meta property="og:title" content="Remplacer sa livebox par un UniFi Security Gateway 3P (USG)"/>
<meta property="og:description" content="Ayant pas mal utilisé le materiel d'ubiquiti j'ai acheté un USG 3 pour la maison. En recherchant un peu sur le net j'ai vu qu'il était possible de remplacer la livebox par l'USG tout en concervant la télévision etc… grâce a des VLANs. Il y a pas mal de manipulations …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="//www.choiz.fr/2017-08-26-remplacer-sa-livebox-par-un-unifi-security-gateway-3p-(usg).html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-08-26 19:00:56+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="//www.choiz.fr/author/choiz.html">
<meta property="article:section" content="text"/>
<meta property="article:tag" content="UniFi"/>
<meta property="article:tag" content="Gateway"/>
<meta property="article:tag" content="Livebox"/>
<meta property="article:tag" content="USG"/>
<meta property="article:tag" content="Network"/>
<meta property="og:image" content="">  <title>ChoiZ &ndash; Remplacer sa livebox par un UniFi Security Gateway 3P (USG)</title>
</head>
<body>
  <aside>
    <div>
      <a href="//www.choiz.fr">
        <img src="//www.choiz.fr/theme/img/profile.png" alt="Blog technique de François LASSERRE" title="Blog technique de François LASSERRE">
      </a>
      <div>
          <a href="//www.choiz.fr">Blog technique de François LASSERRE</a>
      </div>
      <nav>
        <ul class="list">
          <li><a href="/">Home</a></li>
          <li><a href="/archives">Archives</a></li>
          <li><a href="/tags">Tags</a></li>
        </ul>
      </nav>
      <p>Je suis ingénieur informatique, je travail en tant que DevOps chez <a href="//www.manomano.fr">ManoMano</a>. J'aime le développement, le streaming, l'Internet…<br><br>Depuis l'an 2000, j'ai fondé plusieurs webradios Radio-Psylone, Live9 ou encore AddictRadio.</p>
      <ul class="social">
        <li><a class="sc-github" href="//www.github.com/ChoiZ"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-flickr" href="//www.flickr.com/ChoiZ"><i class="fa fa-flickr"></i></a></li>
        <li><a class="sc-lastfm" href="//www.last.fm/user/ChoiZ"><i class="fa fa-lastfm"></i></a></li>
        <li><a class="sc-twitter" href="//www.twitter.com/ChoiZ"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-facebook" href="//www.facebook.com/ChoiZ"><i class="fa fa-facebook"></i></a></li>
        <li><a class="sc-foursquare" href="//www.foursquare.com/ChoiZ"><i class="fa fa-foursquare"></i></a></li>
        <li><a class="sc-linkedin" href="//www.linkedin.com/in/ChoiZ"><i class="fa fa-linkedin"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h1 id="2017-08-26-remplacer-sa-livebox-par-un-unifi-security-gateway-3p-(usg)">Remplacer sa livebox par un UniFi Security Gateway 3P (USG)</h1>
    <p>Posté le sam. 26 août 2017</p>
  </header>
  <div>
    <p>Ayant pas mal utilisé le materiel d'ubiquiti j'ai acheté un USG 3 pour la maison.</p>
<p>En recherchant un peu sur le net j'ai vu qu'il était possible de remplacer la
livebox par l'USG tout en concervant la télévision etc… grâce a des VLANs.</p>
<p>Il y a pas mal de manipulations a faire avant de pouvoir remplacer totalement sa
livebox par l'USG.</p>
<p>J'ai utilisé un raspberry pi qui me permet d'installer un controlleur UniFi qui
permet de gerer son matériel de la marque.</p>
<p>En branchant l'USG au secteur il prend l'adresse IP 192.168.1.1 (la même que la
livebox dans un premier temps ça aide pas…). Je branche donc l'USG en direct sur
mon poste et je me connect en ssh dessus avec les login / pass : "ubnt / ubnt".</p>
<p>Une fois connecté en ssh il faut reconfigurer l'interface eth1 avec l'adresse IP
de votre choix :</p>
<div class="highlight"><pre><span></span># configure
$ set interfaces ethernet eth0 address 192.168.1.10/24
$ delete interfaces ethernet eth0 address 192.168.1.1/24
$ commit
</pre></div>


<p>On commence par dire qu'on assigne sur eth0 l'IP 192.168.1.10 avec un masque
255.255.255.0 et ensuite on supprime l'IP 192.168.1.1 puis on commit. A ce
moment on se fait déconnecté du SSH vu que l'IP à changée.</p>
<p>Si besoin vous pouvez vous reconnecter avec 192.168.1.10.</p>
<p>L'autre méthode pour changer d'IP est de configurer dans le controlleur UniFi
l'IP de votre réseau en 192.168.1.10/24 ensuite il va reprovisionner l'USG avec
cette IP.</p>
<p>Se rendre sur <a href="https://jsfiddle.net/kgersen/45zudr15/embedded/result/">le générateur d'option 90 DHCP</a>
Ajouter votre identifiant fti qui permet de se connecter au réseau orange.</p>
<p>Une chaine va être généré par exemple :
<code>fti/abc1d2e</code>
génére la chaine :
<code>00:00:00:00:00:00:00:00:00:00:00:66:74:69:2f:61:62:63:31:64:32:65</code></p>
<p>Récupérez l'adresse mac de votre livebox (le modem) elle doit être sous la forme :
<code>AA:BB:CC:DD:EE:FF</code></p>
<p>Télécharger les différents fichiers :</p>
<ul>
<li><a href="https://lafibre.info/remplacer-livebox/en-cours-remplacer-sa-livebox-par-un-routeur-ubiquiti-edgemax/?action=dlattach;attach=34373">dhclient3</a></li>
<li><a href="https://gist.githubusercontent.com/ChoiZ/32add22a2addcb00c1b07c8a453a5902/raw/c4f3d9426de070121fb70caa9664efbe76c8b2e3/rfc3442-classless-routes">rfc3442-classless-routes</a></li>
<li><a href="https://gist.githubusercontent.com/ChoiZ/32add22a2addcb00c1b07c8a453a5902/raw/c4f3d9426de070121fb70caa9664efbe76c8b2e3/script.orange.sh">script_orange.sh</a></li>
<li><a href="https://gist.githubusercontent.com/ChoiZ/32add22a2addcb00c1b07c8a453a5902/raw/c4f3d9426de070121fb70caa9664efbe76c8b2e3/config.orange.txt">config.orange.txt</a></li>
</ul>
<p>Modifier dans script_orange.sh et dans config.orange.txt l'adresse mac + la
chaine fti. Recherchez les chaînes que j'ai cité plus haut en exemple.</p>
<p>Faire un scp de dhclient3 rfc3442-classless-route script_orange.sh et
config.orange.txt sur votre USG avec l'utilisateur qui est indiqué dans votre
controlleur dans settings &gt; site &gt; Device Authentication, cliquez sur
le mot de passe pour le faire apparaitre.</p>
<div class="highlight"><pre><span></span><span class="n">scp</span> <span class="n">dhclient3</span> <span class="n">rfc3442</span><span class="o">-</span><span class="n">classless</span><span class="o">-</span><span class="n">routes</span> <span class="n">script_orange</span><span class="p">.</span><span class="n">sh</span> <span class="n">config</span><span class="p">.</span><span class="n">orange</span><span class="p">.</span><span class="n">txt</span> <span class="n">user</span><span class="mf">@192.168.1.20</span><span class="o">:/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span>
</pre></div>


<p>Se connecter en ssh sur votre usg :</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">user</span><span class="mf">@192.168.1.20</span>
</pre></div>


<p>Remplacer le dhclient3 :</p>
<div class="highlight"><pre><span></span>sudo bash
mv dhclient3 /sbin/dhclient3
chmod 775 /sbin/dhclient3
chown root:root /sbin/dhclient3
</pre></div>


<p>Copier la rfc :</p>
<div class="highlight"><pre><span></span>mv rfc3442-classless-routes /etc/dhcp3/dhclient-exit-hooks.d/
chown root:root /etc/dhcp3/dhclient-exit-hooks.d/rfc3442-classless-routes
</pre></div>


<p>Rendre executable le script :</p>
<div class="highlight"><pre><span></span>chmod a+x script_orange.sh
</pre></div>


<p>Copier la config dans /config/</p>
<div class="highlight"><pre><span></span>mv config.orange.txt /config/
</pre></div>


<p>Editer le fichier /opt/vyatta/sbin/vyatta-interfaces.pl et ajouter l'option 90
du dhcp. Il faut aller a la ligne 194 :</p>
<div class="highlight"><pre><span></span><span class="x">    </span><span class="p">$</span><span class="nv">output</span><span class="x"> .= &quot;option rfc3442-classless-static-routes code 121 = array of unsigned integer 8;\n\n&quot;;</span>
</pre></div>


<p>Et ajouter dessous :</p>
<div class="highlight"><pre><span></span><span class="x">    </span><span class="p">$</span><span class="nv">output</span><span class="x"> .= &quot;option rfc3118-auth code 90 = string;\n\n&quot;;</span>
</pre></div>


<p>Maintenant redémarrer l'USG.</p>
<div class="highlight"><pre><span></span>root@ubnt:/home/user# reboot
Proceed with reboot? [confirm]y
</pre></div>


<p>Une fois l'usg de nouveau opérationnel, débrancher votre controlleur du réseau
puis se connecter de nouveau en ssh sur l'usg :</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">user</span><span class="mf">@192.168.1.20</span>
</pre></div>


<p>Reconfigurer l'ip en 192.168.1.1/24 (Débrancher votre livebox du réseau pour pas
avoir de conflit d'ip).</p>
<div class="highlight"><pre><span></span>configure
set interfaces ethernet eth1 address 192.168.1.1/24
delete interfaces ethernet eth1 address 192.168.1.20/24
commit
</pre></div>


<p>Maintenant vous êtes déconnecté du ssh vu que votre USG a changé d'ip.</p>
<p>Se reconnecter en ssh sur la nouvelle ip :</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">user</span><span class="mf">@192.168.1.1</span>
</pre></div>


<p>Se connecter en tant que root pour executer le script</p>
<div class="highlight"><pre><span></span>sudo bash
./script_orange.sh
exit
</pre></div>


<p>Puis lancer un configure et charger la conf :</p>
<div class="highlight"><pre><span></span>configure
load config.orange.txt
</pre></div>


<p>Vous devriez avoir :</p>
<div class="highlight"><pre><span></span>Loading configuration from &#39;/config/config.orange.eth0.txt&#39;...
The specified configuration node is not valid
Set [&#39;service&#39; &#39;gui&#39; &#39;http-port&#39; &#39;80&#39;] failed
The specified configuration node is not valid
Set [&#39;service&#39; &#39;gui&#39; &#39;older-ciphers&#39; &#39;disable&#39;] failed
The specified configuration node is not valid
Set [&#39;system&#39; &#39;offload&#39; &#39;hwnat&#39; &#39;disable&#39;] failed

Load complete.  Use &#39;commit&#39; to make changes active.
[edit]
</pre></div>


<p>Ici je lance un commit pour appliquer la config :</p>
<div class="highlight"><pre><span></span>commit
</pre></div>


<p>Et ça m'affiche :</p>
<div class="highlight"><pre><span></span><span class="k">[ firewall name LAN_IN ]</span>
<span class="err">Firewall</span> <span class="err">config</span> <span class="err">error:</span> <span class="err">Cannot</span> <span class="err">delete</span> <span class="err">rule</span> <span class="err">set</span> <span class="err">&quot;LAN_IN&quot;</span> <span class="err">(still</span> <span class="err">in</span> <span class="err">use)</span>

<span class="k">[ firewall name LAN_LOCAL ]</span>
<span class="err">Firewall</span> <span class="err">config</span> <span class="err">error:</span> <span class="err">Cannot</span> <span class="err">delete</span> <span class="err">rule</span> <span class="err">set</span> <span class="err">&quot;LAN_LOCAL&quot;</span> <span class="err">(still</span> <span class="err">in</span> <span class="err">use)</span>

<span class="k">[ firewall name LAN_OUT ]</span>
<span class="err">Firewall</span> <span class="err">config</span> <span class="err">error:</span> <span class="err">Cannot</span> <span class="err">delete</span> <span class="err">rule</span> <span class="err">set</span> <span class="err">&quot;LAN_OUT&quot;</span> <span class="err">(still</span> <span class="err">in</span> <span class="err">use)</span>

<span class="k">[ firewall name WAN_IN ]</span>
<span class="err">Error:</span> <span class="err">group</span> <span class="err">[guest_restricted_subnets]</span> <span class="err">doesn&#39;t</span> <span class="err">exist</span>

<span class="k">[ firewall name WAN_LOCAL ]</span>
<span class="err">Error:</span> <span class="err">group</span> <span class="err">[guest_restricted_subnets]</span> <span class="err">doesn&#39;t</span> <span class="err">exist</span>

<span class="k">[ system conntrack hash-size 4096 ]</span>
<span class="err">Updated</span> <span class="err">conntrack</span> <span class="err">hash</span> <span class="err">size.</span> <span class="err">This</span> <span class="err">change</span> <span class="err">will</span> <span class="err">take</span> <span class="err">affect</span> <span class="err">when</span> <span class="err">the</span> <span class="err">system</span> <span class="err">is</span> <span class="err">rebooted.</span>

<span class="k">[ interfaces ethernet eth0 address dhcp ]</span>
<span class="err">Stopping</span> <span class="err">DHCP</span> <span class="err">client</span> <span class="err">on</span> <span class="err">eth0</span> <span class="err">...</span>

<span class="k">[ interfaces ethernet eth0 vif 832 address dhcp ]</span>
<span class="err">Starting</span> <span class="err">DHCP</span> <span class="err">client</span> <span class="err">on</span> <span class="err">eth0.832</span> <span class="err">...</span>

<span class="k">[ system syslog ]</span>
<span class="err">Stopping</span> <span class="err">enhanced</span> <span class="err">syslogd:</span> <span class="err">rsyslogd.</span>
<span class="err">Starting</span> <span class="err">enhanced</span> <span class="err">syslogd:</span> <span class="err">rsyslogd.</span>

<span class="k">[ system ntp ]</span>
<span class="err">Stopping</span> <span class="err">NTP</span> <span class="err">server:</span> <span class="err">ntpd.</span>
<span class="err">Starting</span> <span class="err">NTP</span> <span class="err">server:</span> <span class="err">ntpd.</span>

<span class="k">[ service ssh ]</span>
<span class="err">Restarting</span> <span class="err">OpenBSD</span> <span class="err">Secure</span> <span class="err">Shell</span> <span class="err">server:</span> <span class="err">sshd.</span>

<span class="k">[ protocols igmp-proxy ]</span>
<span class="err">Starting</span> <span class="err">IGMP</span> <span class="err">proxy</span>

<span class="k">[ service dhcp-server ]</span>
<span class="err">Stopping</span> <span class="err">DHCP</span> <span class="err">server</span> <span class="err">daemon...</span>
<span class="err">Starting</span> <span class="err">DHCP</span> <span class="err">server</span> <span class="err">daemon...</span>

<span class="err">Commit</span> <span class="err">failed</span>
<span class="k">[edit]</span>
</pre></div>


<p>Malgrès le fail, je fais un save :</p>
<div class="highlight"><pre><span></span>root@ubnt# save
Warning: you have uncommitted changes that will not be saved.

Saving configuration to &#39;/config/config.boot&#39;...
Done
[edit]
</pre></div>


<p>Puis j'éteind l'USG pour remplacer la livebox.</p>
<p>Le port WAN1 pour l'ONT</p>
<p>Le port LAN1 pour votre réseau local</p>
<p>Le port WAN2/LAN2 pour la télévision</p>
<p>Quand j'arrive a joindre l'usg sur l'IP 192.168.1.1 je me reconnect en ssh et je
me connect en root pour sauver la config et l'envoyer sur ma machine.</p>
<div class="highlight"><pre><span></span>sudo bash
mca-ctrl -t dump-cfg &gt; config.gateway.json
scp config.gateway.json user@ma_machine:/home/user/
</pre></div>


<p>Maintenant je me déconnecte de l'usg. Je débranche le câble réseau entre l'usg et
mon réseau local pour pouvoir rebrancher mon controlleur. Si on débranche pas
l'usg il va reprendre la config par defaut du controlleur et il faudra tout
refaire (hormis les copies des fichiers dhclient3 rfc… etc…).</p>
<p>Depuis mon poste je copie sur mon controlleur le fichier config.gateway.json que
je viens de sauver.</p>
<div class="highlight"><pre><span></span>scp config.gateway.json user@mon_controlleur:/home/user
</pre></div>


<p>Puis je me connecte a mon controlleur en ssh pour déposer dans le bon dossier ce
fichier.</p>
<p>Le dossier doit être <strong>/data/sites/default</strong> si vous utilisez le site par defaut.</p>
<p>Reconnecter l'USG a votre réseau.</p>
<p>Il va être de nouveau provisionné par votre controlleur, si vous avez des
erreurs lors de ce provisionning elles seront affichées dans "alerts" sur votre
controlleur. Dans ce cas il y a un truc qui cloche entre votre config et celle
du controlleur revoir les différentes étapes.</p>
<p>Si le provisionning est ok l'USG redémarre et la config est enfin fini ! ;-)</p>
<p>Le tout doit être faisable qu'avec un fichier plutôt que d'utiliser
script_orange.sh + config.orange.txt</p>
<p>Grand merci au forum lafibre.info et particulièrement ce <a href="https://lafibre.info/remplacer-livebox/unifi-security-gateway-en-remplacement-de-la-livebox/">sujet</a>.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="//www.choiz.fr/tag/unifi.html">UniFi</a>
      <a href="//www.choiz.fr/tag/gateway.html">Gateway</a>
      <a href="//www.choiz.fr/tag/livebox.html">Livebox</a>
      <a href="//www.choiz.fr/tag/usg.html">USG</a>
      <a href="//www.choiz.fr/tag/network.html">Network</a>
    </p>
  </div>
</article>

    <footer>
      <p>&copy; François LASSERRE </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/choiz/Flexfork" target="_blank">Flexfork</a> theme by <a href="http://www.choiz.fr">François LASSERRE</a></p>    </footer>
  </main>
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.www.choiz.fr"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//stats.rocketip.net/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '7042kjNK6PYV9LoGM5np']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//stats.rocketip.net/piwik.php?idsite=7042kjNK6PYV9LoGM5np" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code --><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Remplacer sa livebox par un UniFi Security Gateway 3P (USG)",
  "headline": "Remplacer sa livebox par un UniFi Security Gateway 3P (USG)",
  "datePublished": "2017-08-26 19:00:56+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "choiz",
    "url": "//www.choiz.fr/author/choiz.html"
  },
  "image": "{{ SITEURL }}/theme/img/profile.png",
  "url": "//www.choiz.fr/2017-08-26-remplacer-sa-livebox-par-un-unifi-security-gateway-3p-(usg).html",
  "description": "Ayant pas mal utilisé le materiel d'ubiquiti j'ai acheté un USG 3 pour la maison. En recherchant un peu sur le net j'ai vu qu'il était possible de remplacer la livebox par l'USG tout en concervant la télévision etc… grâce a des VLANs. Il y a pas mal de manipulations …"
}
</script></body>
</html>