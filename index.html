<!DOCTYPE html>
<html lang="fr">
<head>
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="//www.choiz.fr/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="//www.choiz.fr/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="//www.choiz.fr/theme/css/font-awesome.min.css">
  <link href="//www.choiz.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ChoiZ Atom">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <meta name="author" content="François LASSERRE" />
  <meta name="description" content="" />
<meta property="og:site_name" content="ChoiZ"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="ChoiZ"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="fr_FR"/>
<meta property="og:url" content="//www.choiz.fr"/>
  <title>ChoiZ</title>
</head>
<body>
  <aside>
    <div>
      <a href="//www.choiz.fr">
        <img src="//www.choiz.fr/theme/img/profile.png" alt="Blog technique de François LASSERRE" title="Blog technique de François LASSERRE">
      </a>
      <div>
          <a href="//www.choiz.fr">Blog technique de François LASSERRE</a>
      </div>
      <nav>
        <ul class="list">
          <li><a href="/">Home</a></li>
          <li><a href="/archives">Archives</a></li>
          <li><a href="/tags">Tags</a></li>
        </ul>
      </nav>
      <p>Je suis ingénieur informatique, je travail en tant que DevOps chez <a href="//www.manomano.fr">ManoMano</a>. J'aime le développement, le streaming, l'Internet…<br><br>Depuis l'an 2000, j'ai fondé plusieurs webradios Radio-Psylone, Live9 ou encore AddictRadio.</p>
      <ul class="social">
        <li><a class="sc-github" href="//www.github.com/ChoiZ"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-flickr" href="//www.flickr.com/ChoiZ"><i class="fa fa-flickr"></i></a></li>
        <li><a class="sc-lastfm" href="//www.last.fm/user/ChoiZ"><i class="fa fa-lastfm"></i></a></li>
        <li><a class="sc-twitter" href="//www.twitter.com/ChoiZ"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-facebook" href="//www.facebook.com/ChoiZ"><i class="fa fa-facebook"></i></a></li>
        <li><a class="sc-foursquare" href="//www.foursquare.com/ChoiZ"><i class="fa fa-foursquare"></i></a></li>
        <li><a class="sc-linkedin" href="//www.linkedin.com/in/ChoiZ"><i class="fa fa-linkedin"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-10-15-faire-un-nat-avec-proxmox.html">Faire du NAT avec Proxmox</a></h2>
    <p>
      Posté le dim. 15 octobre 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/nat.html">NAT</a>,      <a href="//www.choiz.fr/tag/proxmox.html">Proxmox</a>,      <a href="//www.choiz.fr/tag/ipv4.html">IPV4</a>    </p>
  </header>
  <div>
      <p>L'idée est d'utiliser qu'une seule adresse ip public pour plusieurs VM. Comme à
la maison vous avez des adresses ip en 192.168.x.x notre serveur proxmox peut
faire la même chose.</p>
<p>Ip Public de proxmox : 11.22.33.44
Ip Privé de proxmox : 10.0.0.254</p>
<p>Je me connect en ssh à Proxmox et je modifie le fichier <code>/etc/network/interfaces</code>
j'ajoute à la fin du fichier :</p>
<div class="highlight"><pre><span></span>auto vmbr2
iface vmbr2 inet static
    address 10.0.0.254
    netmask 255.255.255.0
    bridge_ports none
    bridge_stp off
    bridge_fd 0
    post-up echo 1 &gt; /proc/sys/net/ipv4/ip_forward
    post-up iptables -t nat -A POSTROUTING -s &#39;10.0.0.0/24&#39; -o vmbr0 -j MASQUERADE
    post-down iptables -t nat -D POSTROUTING -s &#39;10.0.0.0/24&#39; -o vmbr0 -j MASQUERADE
</pre></div>


<p>On peut également ajouter si on veut différents ports qu'on ouvre vers
l'exterieur vers tel ou tel VM ou conteneur.
Par exemple j'ouvre le port 22 de mon conteneur avec l'ip 10.0.0.1 sur le port
8022 de mon ip public :</p>
<div class="highlight"><pre><span></span>    post-up iptables -t nat -A PREROUTING -i vmbr0 -p tcp --dport 8022 -j DNAT --to 10.0.0.1:22
    post-down iptables -t nat -D PREROUTING -i vmbr0 -p tcp --dport 8022 -j DNAT --to 10.0.0.1:22
</pre></div>


<p>Ensuite enregistrer le fichier <code>/etc/network/interfaces</code> puis relancer les
interfaces réseaux</p>
<div class="highlight"><pre><span></span>service networking restart
</pre></div>


<p>Lorsque vous allez faire la configuration réseau d'une VM ou d'un conteneur, il
suffit de renseigner une adresse ip de la plage 10.0.0.0/24</p>
<p>Exemple :</p>
<div class="highlight"><pre><span></span>auto eth0
iface eth0 inet static
    address 10.0.0.1
    netmask 255.255.255.0
    gateway 10.0.0.254
</pre></div>


<p>Puis faites un ping depuis votre conteneur vers l'ip 10.0.0.254, puis vers un
site internet duckduckgo.com par exemple.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-10-15-creer-un-partage-nfs.html">Créer un partage NFS</a></h2>
    <p>
      Posté le dim. 15 octobre 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/partage.html">partage</a>,      <a href="//www.choiz.fr/tag/nfs.html">NFS</a>,      <a href="//www.choiz.fr/tag/linux.html">linux</a>,      <a href="//www.choiz.fr/tag/debian.html">debian</a>,      <a href="//www.choiz.fr/tag/gentoo.html">gentoo</a>    </p>
  </header>
  <div>
      <p>Pour installer un serveur NFS sur Debian voici la marche à suivre :</p>
<div class="highlight"><pre><span></span>apt install nfs-kernel-server
</pre></div>


<p>Une fois le paquet installé, il faut modifier la configuration pour ajouter
votre partage.</p>
<p>Editer le fichier <code>/etc/exports</code></p>
<div class="highlight"><pre><span></span>vim /etc/exports
</pre></div>


<p>J'ajoute dans le fichier le dossier à partager <code>/home/user/share</code> et l'adresse
du ou des clients qui peuvent accèder a ce partage
<code>10.0.0.1(rw,sync,no_subtree_check)</code> ici mon client a l'adresse ip 10.0.0.1 ce
qui donne :</p>
<div class="highlight"><pre><span></span>/home/user/share 10.0.0.1(rw,sync,no_subtree_check)
</pre></div>


<p>Recharger le service :</p>
<div class="highlight"><pre><span></span>service nfs-kernel-server reload
</pre></div>


<p>Vérifier que votre partage est bien actif :</p>
<div class="highlight"><pre><span></span>showmount -e
</pre></div>


<p>Côté client, j'ai installé sur Gentoo : <code>net-fs/nfs-utils</code></p>
<div class="highlight"><pre><span></span>emerge -a net-fs/nfs-utils
</pre></div>


<p>Sur Debian installer le paquet : <code>nfs-common</code></p>
<div class="highlight"><pre><span></span>apt install nfs-common
</pre></div>


<p>Ensuite configurer votre fichier <code>/etc/fstab</code></p>
<div class="highlight"><pre><span></span>vim /etc/fstab
</pre></div>


<p>Ajouter à la fin du fichier l'ip de votre partage avec le nom local puis le
point de montage sur votre client.</p>
<div class="highlight"><pre><span></span>10.0.0.100:/home/user/share /home/user/nfs-nas nfs defaults,user,auto,noatime,intr 0 0
</pre></div>


<p>Puis monter le nouveau partage avec la commande <code>mount -a</code></p>
<p>Si vous faites la commande <code>ls /home/user/nfs-nas</code> vous devriez voir les
fichiers qui se trouvent sur votre serveur.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-09-03-mise-a-jour-de-unifi-security-gateway-3p-(usg).html">Mise à jour de UniFi Security Gateway 3P (USG)</a></h2>
    <p>
      Posté le dim. 03 septembre 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/unifi.html">UniFi</a>,      <a href="//www.choiz.fr/tag/gateway.html">Gateway</a>,      <a href="//www.choiz.fr/tag/usg.html">USG</a>,      <a href="//www.choiz.fr/tag/network.html">Network</a>,      <a href="//www.choiz.fr/tag/update.html">Update</a>    </p>
  </header>
  <div>
      <p>J'ai mis à jour mon USG en version 4.3.49.5001150 aujourd'hui.</p>
<p>Pour qu'il soit toujours fonctionnel derrière une livebox j'ai du refaire les
différentes étapes d'installation de mon article <a href="https://www.choiz.fr/2017-08-26-remplacer-sa-livebox-par-un-unifi-security-gateway-3p-(usg).html">Remplacer sa livebox par un
UniFi Security Gateway 3P
(USG)</a>.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-08-26-remplacer-sa-livebox-par-un-unifi-security-gateway-3p-(usg).html">Remplacer sa livebox par un UniFi Security Gateway 3P (USG)</a></h2>
    <p>
      Posté le sam. 26 août 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/unifi.html">UniFi</a>,      <a href="//www.choiz.fr/tag/gateway.html">Gateway</a>,      <a href="//www.choiz.fr/tag/livebox.html">Livebox</a>,      <a href="//www.choiz.fr/tag/usg.html">USG</a>,      <a href="//www.choiz.fr/tag/network.html">Network</a>    </p>
  </header>
  <div>
      <p>Ayant pas mal utilisé le materiel d'ubiquiti j'ai acheté un USG 3 pour la maison.</p>
<p>En recherchant un peu sur le net j'ai vu qu'il était possible de remplacer la
livebox par l'USG tout en concervant la télévision etc… grâce aux VLANs.</p>
<p>Il y a pas mal de manipulations a faire avant de pouvoir remplacer totalement sa
livebox par l'USG.</p>
<p>J'ai utilisé un raspberry pi qui me permet d'installer un controlleur UniFi qui
permet de gerer son matériel de la marque.</p>
<p>En branchant l'USG au secteur il prend l'adresse IP 192.168.1.1 (la même que la
livebox dans un premier temps ça aide pas…). Je branche donc l'USG en direct sur
mon poste et je me connect en ssh dessus avec les login / pass : "ubnt / ubnt".</p>
<p>Se rendre sur <a href="https://www.l9.fr/usg-config-generator.php">mon générateur de configuration</a> pour générer un fichier config_usg.sh</p>
<p>Puis télécharger les fichiers :</p>
<ul>
<li><a href="https://lafibre.info/remplacer-livebox/en-cours-remplacer-sa-livebox-par-un-routeur-ubiquiti-edgemax/?action=dlattach;attach=34373">dhclient3</a></li>
<li><a href="https://gist.githubusercontent.com/ChoiZ/32add22a2addcb00c1b07c8a453a5902/raw/c4f3d9426de070121fb70caa9664efbe76c8b2e3/rfc3442-classless-routes">rfc3442-classless-routes</a></li>
</ul>
<p>Faire un scp de dhclient3 rfc3442-classless-route config_usg.sh sur votre USG
avec l'utilisateur "ubnt" et le mot de passe "ubnt"</p>
<div class="highlight"><pre><span></span><span class="n">scp</span> <span class="n">dhclient3</span> <span class="n">rfc3442</span><span class="o">-</span><span class="n">classless</span><span class="o">-</span><span class="n">routes</span> <span class="n">config_usg</span><span class="p">.</span><span class="n">sh</span> <span class="n">ubnt</span><span class="mf">@192.168.1.1</span><span class="o">:/</span><span class="n">home</span><span class="o">/</span><span class="n">ubnt</span>
</pre></div>


<p>Se connecter en ssh sur votre usg :</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">ubnt</span><span class="mf">@192.168.1.1</span>
</pre></div>


<p>Remplacer le dhclient3, copier la rfc au bon endroit et rendre executable mon
script :</p>
<div class="highlight"><pre><span></span>sudo bash
mv dhclient3 /sbin/dhclient3
chmod 775 /sbin/dhclient3
chown root:root /sbin/dhclient3
mv rfc3442-classless-routes /etc/dhcp3/dhclient-exit-hooks.d/
chown root:root /etc/dhcp3/dhclient-exit-hooks.d/rfc3442-classless-routes
chmod a+x config_usg.sh
</pre></div>


<p>Editer le fichier /opt/vyatta/sbin/vyatta-interfaces.pl et ajouter l'option 90
du dhcp. Il faut aller a la ligne 194 :</p>
<div class="highlight"><pre><span></span><span class="x">    </span><span class="p">$</span><span class="nv">output</span><span class="x"> .= &quot;option rfc3442-classless-static-routes code 121 = array of unsigned integer 8;\n\n&quot;;</span>
</pre></div>


<p>Et ajouter dessous :</p>
<div class="highlight"><pre><span></span><span class="x">    </span><span class="p">$</span><span class="nv">output</span><span class="x"> .= &quot;option rfc3118-auth code 90 = string;\n\n&quot;;</span>
</pre></div>


<p>Maintenant redémarrer l'USG.</p>
<div class="highlight"><pre><span></span>root@ubnt:/home/ubnt# reboot
Proceed with reboot? [confirm]y
</pre></div>


<p>Débrancher votre controlleur du réseau (pour ne pas que l'USG reprovisionne une 
vielle configuration).</p>
<p>Se connecter de nouveau en ssh sur l'usg :</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">ubnt</span><span class="mf">@192.168.1.1</span>
</pre></div>


<p>Se connecter en tant que root pour executer le script</p>
<div class="highlight"><pre><span></span>sudo bash
./config_usg.sh
</pre></div>


<p>Vous devriez avoir :</p>
<div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">specified</span> <span class="n">configuration</span> <span class="n">node</span> <span class="n">already</span> <span class="n">exists</span>
<span class="p">[</span> <span class="n">service</span> <span class="n">nat</span> <span class="n">rule</span> <span class="mi">6010</span> <span class="n">outbound</span><span class="o">-</span><span class="n">interface</span> <span class="n">eth0</span><span class="mf">.832</span> <span class="p">]</span>
<span class="n">NAT</span> <span class="n">configuration</span> <span class="nl">warning</span><span class="p">:</span> <span class="n">interface</span> <span class="n">eth0</span><span class="mf">.832</span> <span class="n">does</span> <span class="n">not</span> <span class="n">exist</span> <span class="n">on</span> <span class="n">this</span> <span class="n">system</span>

<span class="p">[</span> <span class="n">service</span> <span class="n">nat</span> <span class="n">rule</span> <span class="mi">6011</span> <span class="n">outbound</span><span class="o">-</span><span class="n">interface</span> <span class="n">eth0</span><span class="mf">.838</span> <span class="p">]</span>
<span class="n">NAT</span> <span class="n">configuration</span> <span class="nl">warning</span><span class="p">:</span> <span class="n">interface</span> <span class="n">eth0</span><span class="mf">.838</span> <span class="n">does</span> <span class="n">not</span> <span class="n">exist</span> <span class="n">on</span> <span class="n">this</span> <span class="n">system</span>

<span class="p">[</span> <span class="n">interfaces</span> <span class="n">ethernet</span> <span class="n">eth0</span> <span class="n">vif</span> <span class="mi">838</span> <span class="n">address</span> <span class="n">dhcp</span> <span class="p">]</span>
<span class="n">Starting</span> <span class="n">DHCP</span> <span class="n">client</span> <span class="n">on</span> <span class="n">eth0</span><span class="mf">.838</span> <span class="p">...</span>

<span class="p">[</span> <span class="n">interfaces</span> <span class="n">ethernet</span> <span class="n">eth0</span> <span class="n">vif</span> <span class="mi">832</span> <span class="n">address</span> <span class="n">dhcp</span> <span class="p">]</span>
<span class="n">Starting</span> <span class="n">DHCP</span> <span class="n">client</span> <span class="n">on</span> <span class="n">eth0</span><span class="mf">.832</span> <span class="p">...</span>

<span class="p">[</span> <span class="n">service</span> <span class="n">ssh</span> <span class="p">]</span>
<span class="n">Restarting</span> <span class="n">OpenBSD</span> <span class="n">Secure</span> <span class="n">Shell</span> <span class="nl">server</span><span class="p">:</span> <span class="n">sshd</span><span class="p">.</span>

<span class="p">[</span> <span class="n">protocols</span> <span class="n">igmp</span><span class="o">-</span><span class="n">proxy</span> <span class="p">]</span>
<span class="n">Starting</span> <span class="n">IGMP</span> <span class="n">proxy</span>

<span class="p">[</span> <span class="n">service</span> <span class="n">dhcp</span><span class="o">-</span><span class="n">server</span> <span class="p">]</span>
<span class="n">Stopping</span> <span class="n">DHCP</span> <span class="n">server</span> <span class="n">daemon</span><span class="p">...</span>
<span class="n">Starting</span> <span class="n">DHCP</span> <span class="n">server</span> <span class="n">daemon</span><span class="p">...</span>

<span class="n">Saving</span> <span class="n">configuration</span> <span class="n">to</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">config</span><span class="p">.</span><span class="n">boot</span><span class="err">&#39;</span><span class="p">...</span>
<span class="n">Done</span>
<span class="p">[</span><span class="n">edit</span><span class="p">]</span>
</pre></div>


<p>Puis j'éteind l'USG pour remplacer la livebox.</p>
<p>Le port WAN1 pour l'ONT</p>
<p>Le port LAN1 pour votre réseau local</p>
<p>Le port WAN2/LAN2 pour la télévision</p>
<p>Quand j'arrive a joindre l'usg sur l'IP 192.168.1.1 je me reconnect en ssh et je
me connect en root pour sauver la config et l'envoyer sur ma machine.</p>
<div class="highlight"><pre><span></span>sudo bash
mca-ctrl -t dump-cfg &gt; config.gateway.json
scp config.gateway.json user@ma_machine:/home/user/
</pre></div>


<p>Maintenant je me déconnecte de l'usg. Je débranche le câble réseau entre l'usg et
mon réseau local pour pouvoir rebrancher mon controlleur. Si on débranche pas
l'usg il va reprendre la config par defaut du controlleur et il faudra tout
refaire (hormis les copies des fichiers dhclient3 rfc… etc…).</p>
<p>Depuis mon poste je copie sur mon controlleur le fichier config.gateway.json que
je viens de sauver.</p>
<div class="highlight"><pre><span></span>scp config.gateway.json user@mon_controlleur:/home/user
</pre></div>


<p>Puis je me connecte a mon controlleur en ssh pour déposer dans le bon dossier ce
fichier.</p>
<p>Le dossier doit être <code>/data/sites/default</code> si vous utilisez le site par defaut.</p>
<p>Reconnecter l'USG a votre réseau.</p>
<p>Il va être de nouveau provisionné par votre controlleur, si vous avez des
erreurs lors de ce provisionning elles seront affichées dans "alerts" sur votre
controlleur. Dans ce cas il y a un truc qui cloche entre votre config et celle
du controlleur revoir les différentes étapes.</p>
<p>Si le provisionning est ok l'USG redémarre et la config est enfin fini ! ;-)</p>
<p>Grand merci au forum lafibre.info et particulièrement ce <a href="https://lafibre.info/remplacer-livebox/unifi-security-gateway-en-remplacement-de-la-livebox/">sujet</a>.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-08-26-installation-de-proxmox-ve-5-sur-debian-stretch.html">Installation de Proxmox-VE 5 sur Debian Stretch</a></h2>
    <p>
      Posté le sam. 26 août 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/proxmox.html">Proxmox</a>,      <a href="//www.choiz.fr/tag/debian.html">Debian</a>,      <a href="//www.choiz.fr/tag/stretch.html">Stretch</a>    </p>
  </header>
  <div>
      <p>Suite à l'installation de mon NAS, j'ai installer un proxmox dessus.
Par contre il ne faut pas modifier le sources.list ni installer
firmware-linux-nonfree avant d'installer proxmox (celà ne fonctionne pas du
tout).</p>
<p>Sur debian éditer le fichier /etc/hosts comme ceci :</p>
<div class="highlight"><pre><span></span>127.0.0.1       localhost.localdomain localhost
192.168.15.77   prox4m1.proxmox.com prox4m1 pvelocalhost

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</pre></div>


<p>Puis tester la configuration :</p>
<div class="highlight"><pre><span></span>hostname --ip-address
192.168.15.77 # should return here your IP adress
</pre></div>


<p>Puis on ajoute au sources.list le dépot de proxmox, on récupere la clé et on
update :</p>
<div class="highlight"><pre><span></span>echo &quot;deb http://download.proxmox.com/debian/pve stretch pve-no-subscription&quot; &gt; /etc/apt/sources.list.d/pve-install-repo.list
wget http://download.proxmox.com/debian/proxmox-ve-release-5.x.gpg -O /etc/apt/trusted.gpg.d/proxmox-ve-release-5.x.gpg
apt update &amp;&amp; apt dist-upgrade
</pre></div>


<p>Puis on install les packages Proxmox VE :</p>
<div class="highlight"><pre><span></span>apt install proxmox-ve postfix open-iscsi
</pre></div>


<p>On configure postfix en distribution locale uniquement et à la fin de
l'installation on reboot.</p>
<p>Au reboot vous devriez avoir la main en https sur https://ip_proxmox:8006</p>
<p>S'identifier avec vos login / pass debian.</p>
<p>Pour ne pas avoir la popup qui indique que vous n'avez pas de souscription il
faut modifier le fichier /usr/share/pve-manager/js/pvemanagerlib.js et
rechercher la ligne avec :</p>
<p><code>if (data.status !== 'Active') {</code></p>
<p>remplacer par :</p>
<p><code>if (false /*data.status !== 'Active'*/) {</code></p>
<p>Puis relancer pveproxy avec la commande <code>pveproxy restart</code></p>
<p>Se déconnecter de l'interface proxmox, à la reconnection vous n'aurez plus le
message de souscription.</p>
<p>Puis faire les commandes optionnelles :</p>
<div class="highlight"><pre><span></span>apt remove os-prober
apt remove linux-image-amd64 linux-image-4.9.0-3-amd64
update-grub
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-08-26-upgrade-nas.html">Upgrade NAS</a></h2>
    <p>
      Posté le sam. 26 août 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/nas.html">NAS</a>,      <a href="//www.choiz.fr/tag/hp.html">HP</a>,      <a href="//www.choiz.fr/tag/microserver.html">Microserver</a>,      <a href="//www.choiz.fr/tag/debian.html">Debian</a>,      <a href="//www.choiz.fr/tag/proxmox.html">Proxmox</a>,      <a href="//www.choiz.fr/tag/stockage.html">Stockage</a>,      <a href="//www.choiz.fr/tag/data.html">Data</a>    </p>
  </header>
  <div>
      <p>J'ai acheté il y a quelques années un HP Microserver Gen7 qui me sert de NAS,
dessus j'avais installé Debian 6 à l'époque puis j'ai mis à jour jusqu'à la version 9.</p>
<p>Mon objectif est l'ajout d'un disque car j'ai 4 emplacements pour le stockage et
je n'utilisais que 3 de ses 4 emplacements.</p>
<p>Pour commencer il me fallait un rack 5"¼ permettant de mettre un disque 3"½ ou
2"½, je l'ai trouvé sur <a href="http://www.ldlc.com/fiche/PB00157318.html">LDLC</a> c'est
un "ICY BOX IB-129SSK-B", ensuite j'ai pris sur
<a href="https://www.amazon.fr/gp/product/B01LZY5T8Y/ref=oh_aui_detailpage_o02_s00?ie=UTF8&amp;psc=1">Amazon</a>
un disque Seagate ST500LM030 en 2"½ de 500Go et j'avais ce qu'il fallait pour le
SATA et l'alimentation.</p>
<p>Ce qui m'a permis de mettre un disque 2"½ au niveau de l'emplacement CDROM du HP
Microserver.</p>
<p>J'ai du tué mon uptime d'un an (depuis mon dernier déménagement) :</p>
<div class="highlight"><pre><span></span> 12:31:37 choiz@wayland ~  #❯❯❯ uptime
 12:31:37 up 366 days,  1:08,  1 user,  load average: 0,16, 0,22, 0,24
</pre></div>


<p>Pour la réinstallation j'ai monté un <a href="https://wiki.debian-fr.xyz/PXE_avec_support_EFI">serveur PXE sur
debian</a> merci Benjamin pour le
lien et les conseils.</p>
<p>Installation du TFTP :</p>
<div class="highlight"><pre><span></span># apt install -y tftpd-hpa
</pre></div>


<p>Si vous avez un pare-feu n'oubliez pas d'ouvrir le port 69 :</p>
<div class="highlight"><pre><span></span># iptables -A INPUT -p udp -m udp --dport 69 -j ACCEPT
</pre></div>


<p>Installer le serveur DHCP :</p>
<div class="highlight"><pre><span></span># apt install isc-dhcp-server
</pre></div>


<p>Mes IP sont dans le réseau 192.168.1.0/24, mon router en 192.168.1.1, je met un
range entre 192.168.1.100 et 192.168.1.150 mon serveur TFTP est en 192.168.1.2.</p>
<p>Voici la conf d'isc-dhcp-server :</p>
<div class="highlight"><pre><span></span>default-lease-time 600;
max-lease-time 7200;

allow booting;

# in this example, we serve DHCP requests from 192.168.1.(3 to 253)
# and we have a router at 192.168.1.1
subnet 192.168.1.0 netmask 255.255.255.0 {
  range 192.168.1.100 192.168.1.150;
  option broadcast-address 192.168.1.255;
  option routers 192.168.1.1;
  option domain-name-servers 192.168.1.1;
  filename &quot;pxelinux.0&quot;;
}

group {
  next-server 192.168.1.2;
  host tftpclient {
    filename &quot;pxelinux.0&quot;;
  }
}
</pre></div>


<p>Redémarrer le DHCP pour que la config soit prise en compte.</p>
<div class="highlight"><pre><span></span># systemctl restart isc-dhcp-server
</pre></div>


<p>Maintenant nous téléchargeons la dernière version de debian pour la mettre sur
notre TFTP :</p>
<div class="highlight"><pre><span></span># cd /srv/tftp/
# wget -c http://ftp.fr.debian.org/debian/dists/stretch/main/installer-amd64/current/images/netboot/netboot.tar.gz
# tar -zxf netboot.tar.gz
# rm netboot.tar.gz
# systemctl restart tftpd-hpa
</pre></div>


<p>Le PXE est maintenant fonctionnel avec l'installation de debian.</p>
<p>Je réinstall donc debian 9.1 proprement.</p>
<p>Pour éviter d'avoir ses messages d'erreurs :</p>
<div class="highlight"><pre><span></span><span class="n">W</span><span class="o">:</span> <span class="n">Possible</span> <span class="n">missing</span> <span class="n">firmware</span> <span class="sr">/lib/firmware/tigon/</span><span class="n">tg3_tso5</span><span class="o">.</span><span class="na">bin</span> <span class="k">for</span> <span class="n">module</span> <span class="n">tg3</span>
<span class="n">W</span><span class="o">:</span> <span class="n">Possible</span> <span class="n">missing</span> <span class="n">firmware</span> <span class="sr">/lib/firmware/tigon/</span><span class="n">tg3_tso</span><span class="o">.</span><span class="na">bin</span> <span class="k">for</span> <span class="n">module</span> <span class="n">tg3</span>
<span class="n">W</span><span class="o">:</span> <span class="n">Possible</span> <span class="n">missing</span> <span class="n">firmware</span> <span class="sr">/lib/firmware/tigon/</span><span class="n">tg3</span><span class="o">.</span><span class="na">bin</span> <span class="k">for</span> <span class="n">module</span> <span class="n">tg3</span>
</pre></div>


<p>Je modifie mon fichier /etc/apt/sources.list et j'ajoute les "non-free".</p>
<p>Puis j'install le firmware-linux-nonfree :</p>
<div class="highlight"><pre><span></span>apt update
apt install firmware-linux-nonfree
</pre></div>


<p>Il me reste plus qu'a remonter mes disques de backup et de refaire mes partages.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-06-05-re-generer-une-cle-rsa-publique.html">Re-générer une clé rsa publique</a></h2>
    <p>
      Posté le lun. 05 juin 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/id_rsa.html">id_rsa</a>,      <a href="//www.choiz.fr/tag/rsa.html">rsa</a>,      <a href="//www.choiz.fr/tag/pub.html">pub</a>,      <a href="//www.choiz.fr/tag/key.html">key</a>,      <a href="//www.choiz.fr/tag/ssh.html">ssh</a>    </p>
  </header>
  <div>
      <p>Si vous n'avez plus de clé publique, mais que vous avez toujours votre clé privée vous pouvez regénérer votre clé
publique.</p>
<p>Pour se faire il faut utiliser la commande <em>ssh-keygen</em> avec l'option <em>-y</em> et <em>-f</em> pour désigner la clé privé.</p>
<p><code>ssh-keygen -y -f ~/.ssh/id_rsa &gt; ~/.ssh/id_rsa.pub</code></p>
<p>On utilise ci-dessus l'id_rsa (privée) pour générer l'id_rsa.pub.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-06-01-utiliser-un-bastion-ssh.html">Utiliser un Bastion SSH</a></h2>
    <p>
      Posté le jeu. 01 juin 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/ssh.html">SSH</a>,      <a href="//www.choiz.fr/tag/bastion.html">Bastion</a>,      <a href="//www.choiz.fr/tag/linux.html">linux</a>,      <a href="//www.choiz.fr/tag/unix.html">unix</a>,      <a href="//www.choiz.fr/tag/tunnel.html">tunnel</a>    </p>
  </header>
  <div>
      <p>Pour créer un Bastion SSH il suffit de modifier votre configuration ssh qui se
trouve dans <em>~/.ssh/config</em> et d'ajouter les deux lignes suivantes :</p>
<div class="highlight"><pre><span></span>Host destination.local
    ProxyCommand ssh user@bastion.fr -W %h:%p
</pre></div>


<p>C'est tout.</p>
<p>Explications : on utilise l'host <em>bastion.fr</em> pour se connecter à
<em>destination.local</em>. Quand je tape sur ma machine local <em>ssh
choiz@destination.local</em> mon client SSH lit le fichier de configuration, se
connecte à l'host <em>bastion.fr</em> avec l'utilisateur <em>user</em> puis fait une nouvelle
connexion vers ma destination.</p>
<p>Vous pouvez modifier votre configuration ssh pour se connecter à votre bastion
avec une clé spécifique puis a votre destination avec une autre clé par exemple
ou avec des utilisateurs différents…</p>
<p>Exemple :</p>
<div class="highlight"><pre><span></span>Host bastion.fr
    User toto
    IdentifyFile ~/.ssh/bastion

Host destination.local
    User tata
    IdentifyFile ~/.ssh/destination
</pre></div>


<p>Enjoy vincent.m ;-)</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-05-14-docker-commandes-utiles.html">Docker commandes utiles</a></h2>
    <p>
      Posté le dim. 14 mai 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/docker.html">docker</a>,      <a href="//www.choiz.fr/tag/linux.html">linux</a>,      <a href="//www.choiz.fr/tag/container.html">container</a>    </p>
  </header>
  <div>
      <p>Voici quelques commandes très utiles si vous utilisez docker.</p>
<p>Supprimer tous les containers qui sont arétés :</p>
<div class="highlight"><pre><span></span>docker ps -q | xargs docker rm
</pre></div>


<p>Supprimer toutes les images non utilisées :</p>
<div class="highlight"><pre><span></span>docker images -q | xargs docker rmi
</pre></div>


<p>Se connecter a un conteneur docker lancé par son id :</p>
<div class="highlight"><pre><span></span>docker exec -it id_de_votre_container /bin/bash
</pre></div>


<p>Se connecter a un conteneur docker lancé par son nom :</p>
<div class="highlight"><pre><span></span>docker exec -it nom_de_votre_container /bin/bash
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2016-07-30-convertir-un-.deb-en-archive-.tar.gz.html">Convertir un .deb en archive .tar.gz</a></h2>
    <p>
      Posté le sam. 30 juillet 2016 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/deb.html">deb</a>,      <a href="//www.choiz.fr/tag/targz.html">tar.gz</a>,      <a href="//www.choiz.fr/tag/debian.html">debian</a>,      <a href="//www.choiz.fr/tag/ubuntu.html">ubuntu</a>,      <a href="//www.choiz.fr/tag/archive.html">archive</a>,      <a href="//www.choiz.fr/tag/gentoo.html">gentoo</a>,      <a href="//www.choiz.fr/tag/linux.html">linux</a>    </p>
  </header>
  <div>
      <p>En voulant installer le logiciel "slack" sur ma machine gentoo au travail j'ai
trouvé un logiciel plutôt intéressant nommé "deb2targz".</p>
<p>En effet <a href="https://slack.com/downloads">slack</a> ne dispose que des archives ubuntu
en 32 bits, 64 bits et fedora en 64 bits.</p>
<p>deb2targz permet de convertir un fichier ".deb" en archive ".tar.gz".</p>
<p>Si vous êtes sur gentoo installez le via : <code>emerge -a app-arch/deb2targz</code></p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="//www.choiz.fr/index2.html">
      <i class="fa fa-angle-left"></i> Anciens articles
    </a>
  </div>

    <footer>
      <p>&copy; François LASSERRE </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/choiz/Flexfork" target="_blank">Flexfork</a> theme by <a href="http://www.choiz.fr">François LASSERRE</a></p>    </footer>
  </main>
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.www.choiz.fr"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//stats.rocketip.net/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '7042kjNK6PYV9LoGM5np']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//stats.rocketip.net/piwik.php?idsite=7042kjNK6PYV9LoGM5np" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code --><script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " ChoiZ ",
  "url" : "//www.choiz.fr",
  "image": "",
  "description": ""
}
</script></body>
</html>