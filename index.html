<!DOCTYPE html>
<html lang="fr">
<head>
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="https://www.choiz.fr/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.choiz.fr/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.choiz.fr/theme/css/font-awesome.min.css">
  <link href="https://www.choiz.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ChoiZ Atom">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <meta name="author" content="François LASSERRE" />
  <meta name="description" content="" />
<meta property="og:site_name" content="ChoiZ"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="ChoiZ"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="fr_FR"/>
<meta property="og:url" content="https://www.choiz.fr"/>
  <title>ChoiZ</title>
</head>
<body>
  <aside>
    <div>
      <a href="https://www.choiz.fr">
        <img src="https://www.choiz.fr/theme/img/profile.png" alt="Blog technique de François LASSERRE" title="Blog technique de François LASSERRE">
      </a>
      <div>
          <a href="https://www.choiz.fr">Blog technique de François LASSERRE</a>
      </div>
      <nav>
        <ul class="list">
          <li><a href="/">Home</a></li>
          <li><a href="/archives">Archives</a></li>
          <li><a href="/tags">Tags</a></li>
        </ul>
      </nav>
      <p>Je suis ingénieur informatique, je travail en tant que DevOps chez <a href="https://www.manomano.fr">ManoMano</a>. J'aime le développement, le streaming, l'Internet…<br><br>Depuis l'an 2000, j'ai fondé plusieurs webradios Radio-Psylone, Live9 ou encore AddictRadio.</p>
      <ul class="social">
        <li><a class="sc-github" href="https://www.github.com/ChoiZ"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-flickr" href="https://www.flickr.com/ChoiZ"><i class="fa fa-flickr"></i></a></li>
        <li><a class="sc-lastfm" href="https://www.last.fm/user/ChoiZ"><i class="fa fa-lastfm"></i></a></li>
        <li><a class="sc-twitter" href="https://www.twitter.com/ChoiZ"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/ChoiZ"><i class="fa fa-facebook"></i></a></li>
        <li><a class="sc-foursquare" href="https://www.foursquare.com/ChoiZ"><i class="fa fa-foursquare"></i></a></li>
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/ChoiZ"><i class="fa fa-linkedin"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h2><a href="https://www.choiz.fr/2019-04-23-optimisation-de-pdf-grace-a-imagemagick.html">Optimisation de pdf grâce à ImageMagick</a></h2>
    <p>
      Posté le mar. 23 avril 2019 &#8226;
Tags :
      <a href="https://www.choiz.fr/tag/imagemagick.html">ImageMagick</a>,      <a href="https://www.choiz.fr/tag/pdf.html">pdf</a>,      <a href="https://www.choiz.fr/tag/compress.html">compress</a>    </p>
  </header>
  <div>
      <p>Ayant de gros pdf de 3Mo je cherchais une solution pour les optimiser en ligne de commande.</p>
<p>ImageMagick est doté de l'outil convert qui permet de convertir des images.</p>
<p>Avec la commande suivante j'ai pu convertir un PDF de 3,5Mo en un PDF de 1,5Mo en compressant les pages au format JPG 90%.</p>
<div class="highlight"><pre><span></span>convert -density 300x300 -quality 9 -compress jpeg input.pdf output.pdf
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.choiz.fr/2019-03-24-update-i3-sensible-terminal.html">Update i3-sensible-terminal</a></h2>
    <p>
      Posté le dim. 24 mars 2019 &#8226;
Tags :
      <a href="https://www.choiz.fr/tag/i3wm.html">i3wm</a>,      <a href="https://www.choiz.fr/tag/terminal.html">terminal</a>,      <a href="https://www.choiz.fr/tag/linux.html">linux</a>    </p>
  </header>
  <div>
      <p>En voulant modifier ma config de i3 je me suis aperçu que j'avais modifié la ligne :</p>
<div class="highlight"><pre><span></span>bindsym $mod+Return exec i3-sensible-terminal
</pre></div>


<p>par la ligne suivante :</p>
<div class="highlight"><pre><span></span>bindsym $mod+Return exec urxvt
</pre></div>


<p>Je préfere ne pas modifier cette ligne à chaque installation de i3wm, donc je réédite ma ligne pour utiliser par défaut <code>i3-sensible-terminal</code>.</p>
<p>Pour modifier le terminal executé par la commande <code>i3-sensible-terminal</code> il suffit donc de lancer la commande suivante puis de choisir dans mon cas urxvt :</p>
<div class="highlight"><pre><span></span>update-alternatives --config x-terminal-emulator
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.choiz.fr/2018-12-13-bien-nommer-ses-fichiers.html">Bien nommer ses fichiers</a></h2>
    <p>
      Posté le jeu. 13 décembre 2018 &#8226;
Tags :
      <a href="https://www.choiz.fr/tag/filename.html">filename</a>,      <a href="https://www.choiz.fr/tag/date.html">date</a>    </p>
  </header>
  <div>
      <p>Pour bien nommer vos fichiers une méthode simple est de mettre la date dans le nom du fichier mais… comment faire ?</p>
<p>Il faut mettre Lundi-10-Décembre-2018 dans le nom du fichier ?
Non.</p>
<p>Il faut donc mettre 10-12-2018 dans le nom du fichier ?
Toujours pas.</p>
<p>Ok donc comment faire ?
Pour moi la méthode la plus simple pour bien trier vos fichiers par ordre chronologique, est de commencer par l'année puis le mois puis le jour etc… On précise de plus en plus.
Donc pour le Lundi 10 Décembre 2018 je vais écrire 20181210 ou 2018-12-10.</p>
<p>Pourquoi ?</p>
<p>Lorsque l'on va trier nos fichiers avec le premier cas nous aurons :</p>
<div class="highlight"><pre><span></span>Lundi-10-Décembre-2018
Lundi-11-Décembre-2017
Mardi-11-Décembre-2018
Mardi-12-Décembre-2017
</pre></div>


<p>Le trie se fait jour par jour donc pas du tout par ordre chronologique.
Nous ne retenons pas cette solution.</p>
<p>Avec le second exemple :</p>
<div class="highlight"><pre><span></span>10-12-2018 (Lundi 10 décembre 2018)
11-12-2018 (Mardi 11 décembre 2018)
11-12-2017 (Lundi 11 décembre 2017)
12-12-2017 (Mardi 12 décembre 2017)
</pre></div>


<p>Le trie se fait par jour, puis par mois, puis par année, donc nous avons tous les 10 décembre puis les 11 décembre etc… ce n'est toujours pas par ordre chronologique.
Nous ne retenons pas cette solution.</p>
<p>Avec le dernier exemple :</p>
<div class="highlight"><pre><span></span>2017-12-10 (Lundi 10 décembre 2017)
2017-12-11 (Mardi 11 décembre 2017)
2018-12-11 (Lundi 11 décembre 2018)
2018-12-12 (Mardi 12 décembre 2018)
</pre></div>


<p>C'est bien par ordre chronologique, l'année puis le mois, puis le jour, c'est donc comme ça que nous devons écrire nos fichiers avec une date.</p>
<p>Si vous faites une photo de vous chaque année en septembre vous aurez donc photo.jpg qui sera nommer comme suit :</p>
<div class="highlight"><pre><span></span>2016-09-photo.jpg
2017-09-photo.jpg
2018-09-photo.jpg
</pre></div>


<p>On a pas besoin de préciser le jour dans le cas précédent car on a qu'une photo par an en septembre d'ailleurs on pourrait même simplifier en :</p>
<div class="highlight"><pre><span></span>2016-photo.jpg
2017-photo.jpg
2018-photo.jpg
</pre></div>


<p>Personnellement je préfère toujours mettre mes fichiers sous la forme 2018-09-01-nom-de-fichier.ext ce qui permet d'avoir toujours la date du jour.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.choiz.fr/2018-12-05-ajouter-un-disque-a-une-grappe-raid-mdadm.html">Ajouter un disque a une grappe RAID MDADM</a></h2>
    <p>
      Posté le mer. 05 décembre 2018 &#8226;
Tags :
      <a href="https://www.choiz.fr/tag/raid.html">RAID</a>,      <a href="https://www.choiz.fr/tag/mdadm.html">MDADM</a>    </p>
  </header>
  <div>
      <p>Ayant enfin fini la migration de mon NAS vers mon nouveau NAS, j'ai récupéré mon troisième disque de 10To pour l'ajouter à ma grappe RAID1 qui contient déjà 2 disques de 10To.</p>
<p>Pour ajouter le disque /dev/sdd dans la grappe /dev/md0 il faut tapper la commande suivante :</p>
<div class="highlight"><pre><span></span>mdadm --manage /dev/md0 --add /dev/sdd1
</pre></div>


<p>Si vous n'avez pas de chance comme moi, vous aurez le message d'erreur suivant :</p>
<div class="highlight"><pre><span></span><span class="n">mdadm</span><span class="o">:</span> <span class="n">Cannot</span> <span class="n">open</span> <span class="sr">/dev/s</span><span class="n">dd1</span><span class="o">:</span> <span class="n">Device</span> <span class="n">or</span> <span class="n">resource</span> <span class="n">busy</span>
</pre></div>


<p>Il faut donc redémarrer la machine et éditer le grub à la main… (avec la touche e), puis ajouter dans la ligne avec le kernel <code>nodmraid</code> puis appuyer sur f10 ou b pour booter.</p>
<p>Une fois la machine prête j'ai pu lancer ma commande cette fois-ci avec succès :</p>
<div class="highlight"><pre><span></span>mdadm --manage /dev/md0 --add /dev/sdd1
mdadm: added /dev/sdd1
</pre></div>


<p>Il faut maintenant dire à MDADM qu'on a un raid1 sur 3 disques avec la commande suivante :</p>
<div class="highlight"><pre><span></span>mdadm --grow /dev/md0 --raid-device=3
raid_disks for /dev/md0 set to 3
</pre></div>


<p>Vous pouvez maintenant faire un watch pour voir l'avancement de la copie sur le troisième disque :</p>
<div class="highlight"><pre><span></span>watch cat /proc/mdstat
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.choiz.fr/2018-07-30-installer-et-utiliser-lxc.html">Installer et utiliser lxc</a></h2>
    <p>
      Posté le lun. 30 juillet 2018 &#8226;
Tags :
      <a href="https://www.choiz.fr/tag/linux.html">linux</a>,      <a href="https://www.choiz.fr/tag/container.html">container</a>,      <a href="https://www.choiz.fr/tag/lxc.html">lxc</a>    </p>
  </header>
  <div>
      <p>Installation de lxc sur debian :</p>
<p><code>apt-get install lxc</code></p>
<p>Création d'un conteneur lxc sous debian :</p>
<p><code>lxc-create -n debian9 -t download</code></p>
<p>Sélectionner :</p>
<div class="highlight"><pre><span></span><span class="n">distribution</span><span class="o">:</span> <span class="n">debian</span>
<span class="n">Release</span><span class="o">:</span> <span class="n">strech</span>
<span class="n">Architecture</span><span class="o">:</span> <span class="n">amd64</span>
</pre></div>


<p>Lister les conteneurs :</p>
<div class="highlight"><pre><span></span>lxc-ls -f
NAME        STATE   AUTOSTART GROUPS IPV4 IPV6 
debian9     STOPPED 0         -      -    -
</pre></div>


<p>Copier debian9 en conteneur debian pour l'utiliser pour un wiki par exemple :</p>
<div class="highlight"><pre><span></span>lxc-copy -n debian9 -N debian9wiki -B overlay -s
</pre></div>


<p>Vérifions :</p>
<div class="highlight"><pre><span></span>lxc-ls -f
NAME        STATE   AUTOSTART GROUPS IPV4 IPV6 
debian9     STOPPED 0         -      -    -    
debian9wiki STOPPED 0         -      -    -
</pre></div>


<p>Lancer debian9wiki :</p>
<div class="highlight"><pre><span></span>lxc-start -n debian9wiki
</pre></div>


<p>Vérifions :</p>
<div class="highlight"><pre><span></span>lxc-ls -f
NAME        STATE   AUTOSTART GROUPS IPV4           IPV6 
debian9     STOPPED 0         -      -              -    
debian9wiki RUNNING 0         -      192.168.60.140 -    
</pre></div>


<p>Se connecter a l'aide de lxc-attach :</p>
<div class="highlight"><pre><span></span>lxc-attach -n debian9wiki
</pre></div>


<p>Installer openssh-server</p>
<div class="highlight"><pre><span></span>apt-get install openssh-server
</pre></div>


<p>Ajouter votre utilisateur user :</p>
<div class="highlight"><pre><span></span>useradd user
</pre></div>


<p>Se déconnecter du conteneur et se connecter via ssh avec votre utilisateur user.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.choiz.fr/2017-10-21-installation-d-un-controlleur-unifi-sur-raspberry-pi-3.html">Installation d'un controlleur Unifi sur Raspberry Pi 3</a></h2>
    <p>
      Posté le sam. 21 octobre 2017 &#8226;
Tags :
      <a href="https://www.choiz.fr/tag/raspberrypi.html">RaspberryPi</a>,      <a href="https://www.choiz.fr/tag/unifi.html">Unifi</a>,      <a href="https://www.choiz.fr/tag/debian.html">Debian</a>    </p>
  </header>
  <div>
      <p>Pour commencer il faut télécharger la dernière version de raspbian sur le site
officiel raspberrypi.org. Actuellement c'est 2017-09-07-raspbian-stretch-lite.zip.</p>
<p>Il faut ensuite extraire l'image de l'archive :</p>
<div class="highlight"><pre><span></span>unzip 2017-09-07-raspbian-stretch-lite.zip
</pre></div>


<p>Puis mettre l'image sur une carte micro sd, j'utilise la commande <code>dmesg</code> pour
voir le nom du périphérique USB sur ma machine :</p>
<div class="highlight"><pre><span></span>[5371729.056039] usb-storage 2-1.3:1.0: USB Mass Storage device detected
[5371729.056115] scsi host5: usb-storage 2-1.3:1.0
[5371730.058300] scsi 5:0:0:0: Direct-Access     Single   Flash Reader     1.00 PQ: 0 ANSI: 0
[5371730.058447] sd 5:0:0:0: Attached scsi generic sg1 type 0
[5371730.509370] sd 5:0:0:0: [sdb] 15759360 512-byte logical blocks: (8.07 GB/7.51 GiB)
[5371730.510383] sd 5:0:0:0: [sdb] Write Protect is off
[5371730.510386] sd 5:0:0:0: [sdb] Mode Sense: 03 00 00 00
[5371730.511384] sd 5:0:0:0: [sdb] No Caching mode page found
[5371730.511386] sd 5:0:0:0: [sdb] Assuming drive cache: write through
[5371730.516135]  sdb: sdb1
[5371730.519381] sd 5:0:0:0: [sdb] Attached SCSI removable disk
</pre></div>


<p>Je copie donc l'image sur /dev/sdb « ma microsd d'après dmesg.</p>
<div class="highlight"><pre><span></span>dd bs=4M if=/home/choiz/2017-09-07-raspbian-stretch-lite.img of=/dev/sdb conv=fsync
</pre></div>


<p>Une fois la copie terminée, je déconnecte la micro sd et je démarre le Raspberry Pi.</p>
<div class="highlight"><pre><span></span>dd bs=4M if=2017-09-07-raspbian-stretch-lite.img of=/dev/sdb conv=fsync
442+1 enregistrements lus
442+1 enregistrements écrits
1854590976 bytes (1,9 GB, 1,7 GiB) copied, 288,12 s, 6,4 MB/s
</pre></div>


<p>Une fois le Raspberry Pi démarrer s'identifier avec : pi / raspberry (attention
le clavier est en qwerty pour l'instant donc tapper rqspberry en mot de passe ;-)</p>
<p>Puis tappez la commande <code>sudo bash</code> pour passer en root puis <code>raspi-config</code> pour
configurer votre Raspberry Pi.</p>
<ol>
<li>
<p>Changer les locales (4 Localisation Option, puis I1 Change Locale),
    décocher en_GB.UTF-8 UTF-8 et cocher fr_FR.UTF-8 UTF-8.
    "Default local for the system environment:" choisir fr_FR.UTF-8</p>
</li>
<li>
<p>Changer le timezone (4 Localisation Option, puis I2 Change Timezone),
    choisir Europe, puis Paris.</p>
</li>
<li>
<p>Changer le layout du clavier (4 Localisation Option, puis I3 Change Keyboard 
    Layout), choisir Generic 105-key (Intl) PC, Other, French,
    French - French (Azerty), The Default for keybord layout, et pour finir : No compose key.</p>
</li>
<li>
<p>Changer le pays pour le wifi (4 Localisation Option, puis I4 Change Wi-fi
        Country), choisir FR France.</p>
</li>
<li>
<p>Ajouter le SSH (5 Interfacing Options, P2 SSH) Puis répondre "yes" pour
   activer le serveur SSH.</p>
</li>
<li>
<p>Choisir 7 Advanced Options, A1 Expand Filesystem.</p>
</li>
<li>
<p>Choisir 8 Update pour mettre à jour raspbian.</p>
</li>
<li>
<p>2 Hostname si vous voulez changer le nom de votre raspberry par exemple
"raspberrypi3".</p>
</li>
</ol>
<p>9: Finish, et redémarrer.</p>
<p>Récuperer l'adresse ip du raspberry pi pour se connecter dessus via SSH.</p>
<div class="highlight"><pre><span></span>ssh pi@adresseip
</pre></div>


<p>Nous changeons le mot de passe de l'utilisateur 'pi'</p>
<p>pi@raspberry3:~ $ <code>passwd</code></p>
<p>pi@raspberry3:~ $ <code>sudo bash</code></p>
<p>root@raspberrypi3:/home/pi# <code>apt install dirmngr -y</code></p>
<p>root@raspberrypi3:/home/pi# <code>echo 'deb http://www.ubnt.com/downloads/unifi/debian stable ubiquiti' | tee -a /etc/apt/sources.list.d/ubnt.list &gt; /dev/null</code></p>
<p>root@raspberrypi3:/home/pi# <code>apt-key adv --keyserver keyserver.ubuntu.com --recv C0A52C50</code></p>
<p>root@raspberrypi3:/home/pi# <code>apt update -y</code></p>
<p>root@raspberrypi3:/home/pi# <code>apt install unifi -y</code></p>
<p>root@raspberrypi3:/home/pi# <code>echo 'ENABLE_MONGODB=no' | tee -a /etc/mongodb.conf &gt; /dev/null</code></p>
<p>root@raspberrypi3:/home/pi# <code>apt install oracle-java8-jdk -y</code></p>
<p>root@raspberrypi3:/home/pi# <code>echo 'JAVA_HOME=/usr/lib/jvm/jdk-8-oracle-arm32-vfp-hflt' | tee /etc/default/unifi &gt; /dev/null</code></p>
<p>root@raspberrypi3:/home/pi# <code>reboot</code></p>
<p>Une fois le raspberry pi démarrer se rendre sur <code>https://ip_raspberry:8443</code> vous
devriez avoir votre interface Unifi disponible.</p>
<p>Mettre à jour votre materiel unifi depuis le controlleur. Puis sur le raspberry
pi nous allons changer d'adresse ip pour avoir un réseau séparé.</p>
<div class="highlight"><pre><span></span>ssh pi@adresseip
</pre></div>


<p>pi@raspberry3:~ $ <code>sudo vi /etc/network/interfaces</code></p>
<p>Ajouter à la fin du fichier :</p>
<div class="highlight"><pre><span></span>auto eth0
iface eth0 inet static
    address 10.0.0.10
    network 255.255.255.0
    gateway 10.0.0.1
</pre></div>


<p>Enregistrer le fichier et quitter (ne pas rédémarrer le pi pour l'instant).</p>
<p>Retourner sur l'interface d'unifi et modifier l'adresse ip de votre réseau LAN.</p>
<p>Gateway/Subnet 10.0.0.1/24</p>
<p>Cliquer sur "UPDATE DHCP RANGE" puis enregistrer vos modifications dans l'onglet
Devices votre USG devrait être en "provisionning".
Redémarrez le Raspberry Pi avec <code>sudo reboot</code> puis vous reconnecter au
controlleur avec la nouvelle adresse ip : <code>https://10.0.0.10:8443</code>.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.choiz.fr/2017-10-15-faire-un-nat-avec-proxmox.html">Faire du NAT avec Proxmox</a></h2>
    <p>
      Posté le dim. 15 octobre 2017 &#8226;
Tags :
      <a href="https://www.choiz.fr/tag/nat.html">NAT</a>,      <a href="https://www.choiz.fr/tag/proxmox.html">Proxmox</a>,      <a href="https://www.choiz.fr/tag/ipv4.html">IPV4</a>    </p>
  </header>
  <div>
      <p>L'idée est d'utiliser qu'une seule adresse ip public pour plusieurs VM. Comme à
la maison vous avez des adresses ip en 192.168.x.x notre serveur proxmox peut
faire la même chose.</p>
<p>Ip Public de proxmox : 11.22.33.44
Ip Privé de proxmox : 10.0.0.254</p>
<p>Je me connect en ssh à Proxmox et je modifie le fichier <code>/etc/network/interfaces</code>
j'ajoute à la fin du fichier :</p>
<div class="highlight"><pre><span></span>auto vmbr2
iface vmbr2 inet static
    address 10.0.0.254
    netmask 255.255.255.0
    bridge_ports none
    bridge_stp off
    bridge_fd 0
    post-up echo 1 &gt; /proc/sys/net/ipv4/ip_forward
    post-up iptables -t nat -A POSTROUTING -s &#39;10.0.0.0/24&#39; -o vmbr0 -j MASQUERADE
    post-down iptables -t nat -D POSTROUTING -s &#39;10.0.0.0/24&#39; -o vmbr0 -j MASQUERADE
</pre></div>


<p>On peut également ajouter si on veut différents ports qu'on ouvre vers
l'exterieur vers tel ou tel VM ou conteneur.
Par exemple j'ouvre le port 22 de mon conteneur avec l'ip 10.0.0.1 sur le port
8022 de mon ip public :</p>
<div class="highlight"><pre><span></span>    post-up iptables -t nat -A PREROUTING -i vmbr0 -p tcp --dport 8022 -j DNAT --to 10.0.0.1:22
    post-down iptables -t nat -D PREROUTING -i vmbr0 -p tcp --dport 8022 -j DNAT --to 10.0.0.1:22
</pre></div>


<p>Ensuite enregistrer le fichier <code>/etc/network/interfaces</code> puis relancer les
interfaces réseaux</p>
<div class="highlight"><pre><span></span>service networking restart
</pre></div>


<p>Lorsque vous allez faire la configuration réseau d'une VM ou d'un conteneur, il
suffit de renseigner une adresse ip de la plage 10.0.0.0/24</p>
<p>Exemple :</p>
<div class="highlight"><pre><span></span>auto eth0
iface eth0 inet static
    address 10.0.0.1
    netmask 255.255.255.0
    gateway 10.0.0.254
</pre></div>


<p>Puis faites un ping depuis votre conteneur vers l'ip 10.0.0.254, puis vers un
site internet duckduckgo.com par exemple.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.choiz.fr/2017-10-15-creer-un-partage-nfs.html">Créer un partage NFS</a></h2>
    <p>
      Posté le dim. 15 octobre 2017 &#8226;
Tags :
      <a href="https://www.choiz.fr/tag/partage.html">partage</a>,      <a href="https://www.choiz.fr/tag/nfs.html">NFS</a>,      <a href="https://www.choiz.fr/tag/linux.html">linux</a>,      <a href="https://www.choiz.fr/tag/debian.html">debian</a>,      <a href="https://www.choiz.fr/tag/gentoo.html">gentoo</a>    </p>
  </header>
  <div>
      <p>Pour installer un serveur NFS sur Debian voici la marche à suivre :</p>
<div class="highlight"><pre><span></span>apt install nfs-kernel-server
</pre></div>


<p>Une fois le paquet installé, il faut modifier la configuration pour ajouter
votre partage.</p>
<p>Editer le fichier <code>/etc/exports</code></p>
<div class="highlight"><pre><span></span>vim /etc/exports
</pre></div>


<p>J'ajoute dans le fichier le dossier à partager <code>/home/user/share</code> et l'adresse
du ou des clients qui peuvent accèder a ce partage
<code>10.0.0.1(rw,sync,no_subtree_check)</code> ici mon client a l'adresse ip 10.0.0.1 ce
qui donne :</p>
<div class="highlight"><pre><span></span>/home/user/share 10.0.0.1(rw,sync,no_subtree_check)
</pre></div>


<p>Recharger le service :</p>
<div class="highlight"><pre><span></span>service nfs-kernel-server reload
</pre></div>


<p>Vérifier que votre partage est bien actif :</p>
<div class="highlight"><pre><span></span>showmount -e
</pre></div>


<p>Côté client, j'ai installé sur Gentoo : <code>net-fs/nfs-utils</code></p>
<div class="highlight"><pre><span></span>emerge -a net-fs/nfs-utils
</pre></div>


<p>Sur Debian installer le paquet : <code>nfs-common</code></p>
<div class="highlight"><pre><span></span>apt install nfs-common
</pre></div>


<p>Ensuite configurer votre fichier <code>/etc/fstab</code></p>
<div class="highlight"><pre><span></span>vim /etc/fstab
</pre></div>


<p>Ajouter à la fin du fichier l'ip de votre partage avec le nom local puis le
point de montage sur votre client.</p>
<div class="highlight"><pre><span></span>10.0.0.100:/home/user/share /home/user/nfs-nas nfs defaults,user,auto,noatime,intr 0 0
</pre></div>


<p>Puis monter le nouveau partage avec la commande <code>mount -a</code></p>
<p>Si vous faites la commande <code>ls /home/user/nfs-nas</code> vous devriez voir les
fichiers qui se trouvent sur votre serveur.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.choiz.fr/2017-08-26-remplacer-sa-livebox-par-un-unifi-security-gateway-3p-(usg).html">Remplacer sa livebox par un UniFi Security Gateway 3P (USG)</a></h2>
    <p>
      Posté le sam. 26 août 2017 &#8226;
Tags :
      <a href="https://www.choiz.fr/tag/unifi.html">UniFi</a>,      <a href="https://www.choiz.fr/tag/gateway.html">Gateway</a>,      <a href="https://www.choiz.fr/tag/livebox.html">Livebox</a>,      <a href="https://www.choiz.fr/tag/usg.html">USG</a>,      <a href="https://www.choiz.fr/tag/network.html">Network</a>    </p>
  </header>
  <div>
      <p>Ayant pas mal utilisé le materiel d'ubiquiti j'ai acheté un USG 3 pour la maison.</p>
<p>En recherchant un peu sur le net j'ai vu qu'il était possible de remplacer la
livebox par l'USG tout en concervant la télévision etc… grâce aux VLANs.</p>
<p>Il y a pas mal de manipulations a faire avant de pouvoir remplacer totalement sa
livebox par l'USG.</p>
<p>J'ai utilisé un raspberry pi qui me permet d'installer un controlleur UniFi qui
permet de gerer son matériel de la marque.</p>
<p>En branchant l'USG au secteur il prend l'adresse IP 192.168.1.1 (la même que la
livebox dans un premier temps ça aide pas…). Je branche donc l'USG en direct sur
mon poste et je me connect en ssh dessus avec les login / pass : "ubnt / ubnt".</p>
<p>Se rendre sur <a href="https://www.l9.fr/usg-config-generator.php">mon générateur de configuration</a> pour générer un fichier config_usg.sh</p>
<p>Puis télécharger les fichiers :</p>
<ul>
<li><a href="https://lafibre.info/remplacer-livebox/en-cours-remplacer-sa-livebox-par-un-routeur-ubiquiti-edgemax/?action=dlattach;attach=34373">dhclient3</a></li>
<li><a href="https://gist.githubusercontent.com/ChoiZ/32add22a2addcb00c1b07c8a453a5902/raw/c4f3d9426de070121fb70caa9664efbe76c8b2e3/rfc3442-classless-routes">rfc3442-classless-routes</a></li>
</ul>
<p>Faire un scp de dhclient3 rfc3442-classless-route config_usg.sh sur votre USG
avec l'utilisateur "ubnt" et le mot de passe "ubnt"</p>
<div class="highlight"><pre><span></span><span class="n">scp</span> <span class="n">dhclient3</span> <span class="n">rfc3442</span><span class="o">-</span><span class="n">classless</span><span class="o">-</span><span class="n">routes</span> <span class="n">config_usg</span><span class="p">.</span><span class="n">sh</span> <span class="n">ubnt</span><span class="mf">@192.168.1.1</span><span class="o">:/</span><span class="n">home</span><span class="o">/</span><span class="n">ubnt</span>
</pre></div>


<p>Se connecter en ssh sur votre usg :</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">ubnt</span><span class="mf">@192.168.1.1</span>
</pre></div>


<p>Remplacer le dhclient3, copier la rfc au bon endroit et rendre executable mon
script :</p>
<div class="highlight"><pre><span></span>sudo bash
mv dhclient3 /sbin/dhclient3
chmod 775 /sbin/dhclient3
chown root:root /sbin/dhclient3
mv rfc3442-classless-routes /etc/dhcp3/dhclient-exit-hooks.d/
chown root:root /etc/dhcp3/dhclient-exit-hooks.d/rfc3442-classless-routes
chmod a+x config_usg.sh
</pre></div>


<p>Editer le fichier /opt/vyatta/sbin/vyatta-interfaces.pl et ajouter l'option 90
du dhcp. Il faut aller a la ligne 194 :</p>
<div class="highlight"><pre><span></span>    $output .= &quot;option rfc3442-classless-static-routes code 121 = array of unsigned integer 8;\n\n&quot;;
</pre></div>


<p>Et ajouter dessous :</p>
<div class="highlight"><pre><span></span>    $output .= &quot;option rfc3118-auth code 90 = string;\n\n&quot;;
</pre></div>


<p>Maintenant redémarrer l'USG.</p>
<div class="highlight"><pre><span></span>root@ubnt:/home/ubnt# reboot
Proceed with reboot? [confirm]y
</pre></div>


<p>Débrancher votre controlleur du réseau (pour ne pas que l'USG reprovisionne une 
vielle configuration).</p>
<p>Se connecter de nouveau en ssh sur l'usg :</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">ubnt</span><span class="mf">@192.168.1.1</span>
</pre></div>


<p>Se connecter en tant que root pour executer le script</p>
<div class="highlight"><pre><span></span>sudo bash
./config_usg.sh
</pre></div>


<p>Vous devriez avoir :</p>
<div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">specified</span> <span class="n">configuration</span> <span class="n">node</span> <span class="n">already</span> <span class="n">exists</span>
<span class="p">[</span> <span class="n">service</span> <span class="n">nat</span> <span class="n">rule</span> <span class="mi">6010</span> <span class="n">outbound</span><span class="o">-</span><span class="n">interface</span> <span class="n">eth0</span><span class="mf">.832</span> <span class="p">]</span>
<span class="n">NAT</span> <span class="n">configuration</span> <span class="nl">warning</span><span class="p">:</span> <span class="n">interface</span> <span class="n">eth0</span><span class="mf">.832</span> <span class="n">does</span> <span class="n">not</span> <span class="n">exist</span> <span class="n">on</span> <span class="n">this</span> <span class="n">system</span>

<span class="p">[</span> <span class="n">service</span> <span class="n">nat</span> <span class="n">rule</span> <span class="mi">6011</span> <span class="n">outbound</span><span class="o">-</span><span class="n">interface</span> <span class="n">eth0</span><span class="mf">.838</span> <span class="p">]</span>
<span class="n">NAT</span> <span class="n">configuration</span> <span class="nl">warning</span><span class="p">:</span> <span class="n">interface</span> <span class="n">eth0</span><span class="mf">.838</span> <span class="n">does</span> <span class="n">not</span> <span class="n">exist</span> <span class="n">on</span> <span class="n">this</span> <span class="n">system</span>

<span class="p">[</span> <span class="n">interfaces</span> <span class="n">ethernet</span> <span class="n">eth0</span> <span class="n">vif</span> <span class="mi">838</span> <span class="n">address</span> <span class="n">dhcp</span> <span class="p">]</span>
<span class="n">Starting</span> <span class="n">DHCP</span> <span class="n">client</span> <span class="n">on</span> <span class="n">eth0</span><span class="mf">.838</span> <span class="p">...</span>

<span class="p">[</span> <span class="n">interfaces</span> <span class="n">ethernet</span> <span class="n">eth0</span> <span class="n">vif</span> <span class="mi">832</span> <span class="n">address</span> <span class="n">dhcp</span> <span class="p">]</span>
<span class="n">Starting</span> <span class="n">DHCP</span> <span class="n">client</span> <span class="n">on</span> <span class="n">eth0</span><span class="mf">.832</span> <span class="p">...</span>

<span class="p">[</span> <span class="n">service</span> <span class="n">ssh</span> <span class="p">]</span>
<span class="n">Restarting</span> <span class="n">OpenBSD</span> <span class="n">Secure</span> <span class="n">Shell</span> <span class="nl">server</span><span class="p">:</span> <span class="n">sshd</span><span class="p">.</span>

<span class="p">[</span> <span class="n">protocols</span> <span class="n">igmp</span><span class="o">-</span><span class="n">proxy</span> <span class="p">]</span>
<span class="n">Starting</span> <span class="n">IGMP</span> <span class="n">proxy</span>

<span class="p">[</span> <span class="n">service</span> <span class="n">dhcp</span><span class="o">-</span><span class="n">server</span> <span class="p">]</span>
<span class="n">Stopping</span> <span class="n">DHCP</span> <span class="n">server</span> <span class="n">daemon</span><span class="p">...</span>
<span class="n">Starting</span> <span class="n">DHCP</span> <span class="n">server</span> <span class="n">daemon</span><span class="p">...</span>

<span class="n">Saving</span> <span class="n">configuration</span> <span class="n">to</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">config</span><span class="p">.</span><span class="n">boot</span><span class="err">&#39;</span><span class="p">...</span>
<span class="n">Done</span>
<span class="p">[</span><span class="n">edit</span><span class="p">]</span>
</pre></div>


<p>Puis j'éteind l'USG pour remplacer la livebox.</p>
<p>Le port WAN1 pour l'ONT</p>
<p>Le port LAN1 pour votre réseau local</p>
<p>Le port WAN2/LAN2 pour la télévision</p>
<p>Quand j'arrive a joindre l'usg sur l'IP 192.168.1.1 je me reconnect en ssh et je
me connect en root pour sauver la config et l'envoyer sur ma machine.</p>
<div class="highlight"><pre><span></span>sudo bash
mca-ctrl -t dump-cfg &gt; config.gateway.json
scp config.gateway.json user@ma_machine:/home/user/
</pre></div>


<p>Maintenant je me déconnecte de l'usg. Je débranche le câble réseau entre l'usg et
mon réseau local pour pouvoir rebrancher mon controlleur. Si on débranche pas
l'usg il va reprendre la config par defaut du controlleur et il faudra tout
refaire (hormis les copies des fichiers dhclient3 rfc… etc…).</p>
<p>Depuis mon poste je copie sur mon controlleur le fichier config.gateway.json que
je viens de sauver.</p>
<div class="highlight"><pre><span></span>scp config.gateway.json user@mon_controlleur:/home/user
</pre></div>


<p>Puis je me connecte a mon controlleur en ssh pour déposer dans le bon dossier ce
fichier.</p>
<p>Le dossier doit être <code>/data/sites/default</code> si vous utilisez le site par defaut.</p>
<p>Reconnecter l'USG a votre réseau.</p>
<p>Il va être de nouveau provisionné par votre controlleur, si vous avez des
erreurs lors de ce provisionning elles seront affichées dans "alerts" sur votre
controlleur. Dans ce cas il y a un truc qui cloche entre votre config et celle
du controlleur revoir les différentes étapes.</p>
<p>Si le provisionning est ok l'USG redémarre et la config est enfin fini ! ;-)</p>
<p>Grand merci au forum lafibre.info et particulièrement ce <a href="https://lafibre.info/remplacer-livebox/unifi-security-gateway-en-remplacement-de-la-livebox/">sujet</a>.</p>
<p><a href="http://amzn.to/2xXmsDO">Ubiquiti Networks USG</a> sur Amazon.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://www.choiz.fr/2017-08-26-installation-de-proxmox-ve-5-sur-debian-stretch.html">Installation de Proxmox-VE 5 sur Debian Stretch</a></h2>
    <p>
      Posté le sam. 26 août 2017 &#8226;
Tags :
      <a href="https://www.choiz.fr/tag/proxmox.html">Proxmox</a>,      <a href="https://www.choiz.fr/tag/debian.html">Debian</a>,      <a href="https://www.choiz.fr/tag/stretch.html">Stretch</a>    </p>
  </header>
  <div>
      <p>Suite à l'installation de mon NAS, j'ai installer un proxmox dessus.
Par contre il ne faut pas modifier le sources.list ni installer
firmware-linux-nonfree avant d'installer proxmox (celà ne fonctionne pas du
tout).</p>
<p>Sur debian éditer le fichier /etc/hosts comme ceci :</p>
<div class="highlight"><pre><span></span>127.0.0.1       localhost.localdomain localhost
192.168.15.77   prox4m1.proxmox.com prox4m1 pvelocalhost

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</pre></div>


<p>Puis tester la configuration :</p>
<div class="highlight"><pre><span></span>hostname --ip-address
192.168.15.77 # should return here your IP adress
</pre></div>


<p>Puis on ajoute au sources.list le dépot de proxmox, on récupere la clé et on
update :</p>
<div class="highlight"><pre><span></span>echo &quot;deb http://download.proxmox.com/debian/pve stretch pve-no-subscription&quot; &gt; /etc/apt/sources.list.d/pve-install-repo.list
wget http://download.proxmox.com/debian/proxmox-ve-release-5.x.gpg -O /etc/apt/trusted.gpg.d/proxmox-ve-release-5.x.gpg
apt update &amp;&amp; apt dist-upgrade
</pre></div>


<p>Puis on install les packages Proxmox VE :</p>
<div class="highlight"><pre><span></span>apt install proxmox-ve postfix open-iscsi
</pre></div>


<p>On configure postfix en distribution locale uniquement et à la fin de
l'installation on reboot.</p>
<p>Au reboot vous devriez avoir la main en https sur https://ip_proxmox:8006</p>
<p>S'identifier avec vos login / pass debian.</p>
<p>Pour ne pas avoir la popup qui indique que vous n'avez pas de souscription il
faut modifier le fichier /usr/share/pve-manager/js/pvemanagerlib.js et
rechercher la ligne avec :</p>
<p><code>if (data.status !== 'Active') {</code></p>
<p>remplacer par :</p>
<p><code>if (false /*data.status !== 'Active'*/) {</code></p>
<p>Puis relancer pveproxy avec la commande <code>pveproxy restart</code></p>
<p>Se déconnecter de l'interface proxmox, à la reconnection vous n'aurez plus le
message de souscription.</p>
<p>Puis faire les commandes optionnelles :</p>
<div class="highlight"><pre><span></span>apt remove os-prober
apt remove linux-image-amd64 linux-image-4.9.0-3-amd64
update-grub
</pre></div>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="https://www.choiz.fr/index2.html">
      <i class="fa fa-angle-left"></i> Anciens articles
    </a>
  </div>

    <footer>
      <p>&copy; François LASSERRE </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/choiz/Flexfork" target="_blank">Flexfork</a> theme by <a href="http://www.choiz.fr">François LASSERRE</a></p>    </footer>
  </main>
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.www.choiz.fr"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//stats.rocketip.net/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '7042kjNK6PYV9LoGM5np']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//stats.rocketip.net/piwik.php?idsite=7042kjNK6PYV9LoGM5np" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code --><script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " ChoiZ ",
  "url" : "https://www.choiz.fr",
  "image": "",
  "description": ""
}
</script></body>
</html>