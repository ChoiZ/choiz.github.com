<!DOCTYPE html>
<html lang="fr">
<head>
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="//www.choiz.fr/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="//www.choiz.fr/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="//www.choiz.fr/theme/css/font-awesome.min.css">
  <link href="//www.choiz.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ChoiZ Atom">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <meta name="author" content="François LASSERRE" />
  <meta name="description" content="" />
<meta property="og:site_name" content="ChoiZ"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="ChoiZ"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="fr_FR"/>
<meta property="og:url" content="//www.choiz.fr"/>
  <title>ChoiZ</title>
</head>
<body>
  <aside>
    <div>
      <a href="//www.choiz.fr">
        <img src="//www.choiz.fr/theme/img/profile.png" alt="Blog technique de François LASSERRE" title="Blog technique de François LASSERRE">
      </a>
      <div>
          <a href="//www.choiz.fr">Blog technique de François LASSERRE</a>
      </div>
      <nav>
        <ul class="list">
          <li><a href="/">Home</a></li>
          <li><a href="/archives">Archives</a></li>
          <li><a href="/tags">Tags</a></li>
        </ul>
      </nav>
      <p>Je suis ingénieur informatique, je travail en tant que DevOps chez <a href="https://www.manomano.fr">ManoMano</a>. J'aime le développement, le streaming, l'Internet…<br><br>Depuis l'an 2000, j'ai fondé plusieurs webradios Radio-Psylone, Live9 ou encore AddictRadio. Je suis vice-président de l'association <a href="https://www.frequence3.fr">Fréquence 3</a>.</p>
      <ul class="social">
        <li><a class="sc-github" href="https://www.github.com/ChoiZ"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-flickr" href="https://www.flickr.com/ChoiZ"><i class="fa fa-flickr"></i></a></li>
        <li><a class="sc-lastfm" href="https://www.last.fm/user/ChoiZ"><i class="fa fa-lastfm"></i></a></li>
        <li><a class="sc-twitter" href="https://www.twitter.com/ChoiZ"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/ChoiZ"><i class="fa fa-facebook"></i></a></li>
        <li><a class="sc-foursquare" href="https://www.foursquare.com/ChoiZ"><i class="fa fa-foursquare"></i></a></li>
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/ChoiZ"><i class="fa fa-linkedin"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-08-26-upgrade-nas.html">Upgrade NAS</a></h2>
    <p>
      Posté le sam. 26 août 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/nas.html">NAS</a>,      <a href="//www.choiz.fr/tag/hp.html">HP</a>,      <a href="//www.choiz.fr/tag/microserver.html">Microserver</a>,      <a href="//www.choiz.fr/tag/debian.html">Debian</a>,      <a href="//www.choiz.fr/tag/proxmox.html">Proxmox</a>,      <a href="//www.choiz.fr/tag/stockage.html">Stockage</a>,      <a href="//www.choiz.fr/tag/data.html">Data</a>    </p>
  </header>
  <div>
      <p>J'ai acheté il y a quelques années un HP Microserver Gen7 qui me sert de NAS,
dessus j'avais installé Debian 6 à l'époque puis j'ai mis à jour jusqu'à la version 9.</p>
<p>Mon objectif est l'ajout d'un disque car j'ai 4 emplacements pour le stockage et
je n'utilisais que 3 de ses 4 emplacements.</p>
<p>Pour commencer il me fallait un rack 5"¼ permettant de mettre un disque 3"½ ou
2"½, je l'ai trouvé sur <a href="http://www.ldlc.com/fiche/PB00157318.html">LDLC</a> c'est
un "ICY BOX IB-129SSK-B", ensuite j'ai pris sur
<a href="https://www.amazon.fr/gp/product/B01LZY5T8Y/ref=oh_aui_detailpage_o02_s00?ie=UTF8&amp;psc=1">Amazon</a>
un disque Seagate ST500LM030 en 2"½ de 500Go et j'avais ce qu'il fallait pour le
SATA et l'alimentation.</p>
<p>Ce qui m'a permis de mettre un disque 2"½ au niveau de l'emplacement CDROM du HP
Microserver.</p>
<p>J'ai du tué mon uptime d'un an (depuis mon dernier déménagement) :</p>
<div class="highlight"><pre><span></span> 12:31:37 choiz@wayland ~  #❯❯❯ uptime
 12:31:37 up 366 days,  1:08,  1 user,  load average: 0,16, 0,22, 0,24
</pre></div>


<p>Pour la réinstallation j'ai monté un <a href="https://wiki.debian-fr.xyz/PXE_avec_support_EFI">serveur PXE sur
debian</a> merci Benjamin pour le
lien et les conseils.</p>
<p>Installation du TFTP :</p>
<div class="highlight"><pre><span></span># apt install -y tftpd-hpa
</pre></div>


<p>Si vous avez un pare-feu n'oubliez pas d'ouvrir le port 69 :</p>
<div class="highlight"><pre><span></span># iptables -A INPUT -p udp -m udp --dport 69 -j ACCEPT
</pre></div>


<p>Installer le serveur DHCP :</p>
<div class="highlight"><pre><span></span># apt install isc-dhcp-server
</pre></div>


<p>Mes IP sont dans le réseau 192.168.1.0/24, mon router en 192.168.1.1, je met un
range entre 192.168.1.100 et 192.168.1.150 mon serveur TFTP est en 192.168.1.2.</p>
<p>Voici la conf d'isc-dhcp-server :</p>
<div class="highlight"><pre><span></span>default-lease-time 600;
max-lease-time 7200;

allow booting;

# in this example, we serve DHCP requests from 192.168.1.(3 to 253)
# and we have a router at 192.168.1.1
subnet 192.168.1.0 netmask 255.255.255.0 {
  range 192.168.1.100 192.168.1.150;
  option broadcast-address 192.168.1.255;
  option routers 192.168.1.1;
  option domain-name-servers 192.168.1.1;
  filename &quot;pxelinux.0&quot;;
}

group {
  next-server 192.168.1.2;
  host tftpclient {
    filename &quot;pxelinux.0&quot;;
  }
}
</pre></div>


<p>Redémarrer le DHCP pour que la config soit prise en compte.</p>
<div class="highlight"><pre><span></span># systemctl restart isc-dhcp-server
</pre></div>


<p>Maintenant nous téléchargeons la dernière version de debian pour la mettre sur
notre TFTP :</p>
<div class="highlight"><pre><span></span># cd /srv/tftp/
# wget -c http://ftp.fr.debian.org/debian/dists/stretch/main/installer-amd64/current/images/netboot/netboot.tar.gz
# tar -zxf netboot.tar.gz
# rm netboot.tar.gz
# systemctl restart tftpd-hpa
</pre></div>


<p>Le PXE est maintenant fonctionnel avec l'installation de debian.</p>
<p>Je réinstall donc debian 9.1 proprement.</p>
<p>Pour éviter d'avoir ses messages d'erreurs :</p>
<div class="highlight"><pre><span></span><span class="n">W</span><span class="o">:</span> <span class="n">Possible</span> <span class="n">missing</span> <span class="n">firmware</span> <span class="sr">/lib/firmware/tigon/</span><span class="n">tg3_tso5</span><span class="o">.</span><span class="na">bin</span> <span class="k">for</span> <span class="n">module</span> <span class="n">tg3</span>
<span class="n">W</span><span class="o">:</span> <span class="n">Possible</span> <span class="n">missing</span> <span class="n">firmware</span> <span class="sr">/lib/firmware/tigon/</span><span class="n">tg3_tso</span><span class="o">.</span><span class="na">bin</span> <span class="k">for</span> <span class="n">module</span> <span class="n">tg3</span>
<span class="n">W</span><span class="o">:</span> <span class="n">Possible</span> <span class="n">missing</span> <span class="n">firmware</span> <span class="sr">/lib/firmware/tigon/</span><span class="n">tg3</span><span class="o">.</span><span class="na">bin</span> <span class="k">for</span> <span class="n">module</span> <span class="n">tg3</span>
</pre></div>


<p>Je modifie mon fichier /etc/apt/sources.list et j'ajoute les "non-free".</p>
<p>Puis j'install le firmware-linux-nonfree :</p>
<div class="highlight"><pre><span></span>apt update
apt install firmware-linux-nonfree
</pre></div>


<p>Il me reste plus qu'a remonter mes disques de backup et de refaire mes partages.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-06-05-re-generer-une-cle-rsa-publique.html">Re-générer une clé rsa publique</a></h2>
    <p>
      Posté le lun. 05 juin 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/id_rsa.html">id_rsa</a>,      <a href="//www.choiz.fr/tag/rsa.html">rsa</a>,      <a href="//www.choiz.fr/tag/pub.html">pub</a>,      <a href="//www.choiz.fr/tag/key.html">key</a>,      <a href="//www.choiz.fr/tag/ssh.html">ssh</a>    </p>
  </header>
  <div>
      <p>Si vous n'avez plus de clé publique, mais que vous avez toujours votre clé privée vous pouvez regénérer votre clé
publique.</p>
<p>Pour se faire il faut utiliser la commande <em>ssh-keygen</em> avec l'option <em>-y</em> et <em>-f</em> pour désigner la clé privé.</p>
<p><code>ssh-keygen -y -f ~/.ssh/id_rsa &gt; ~/.ssh/id_rsa.pub</code></p>
<p>On utilise ci-dessus l'id_rsa (privée) pour générer l'id_rsa.pub.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-06-01-utiliser-un-bastion-ssh.html">Utiliser un Bastion SSH</a></h2>
    <p>
      Posté le jeu. 01 juin 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/ssh.html">SSH</a>,      <a href="//www.choiz.fr/tag/bastion.html">Bastion</a>,      <a href="//www.choiz.fr/tag/linux.html">linux</a>,      <a href="//www.choiz.fr/tag/unix.html">unix</a>,      <a href="//www.choiz.fr/tag/tunnel.html">tunnel</a>    </p>
  </header>
  <div>
      <p>Pour créer un Bastion SSH il suffit de modifier votre configuration ssh qui se
trouve dans <em>~/.ssh/config</em> et d'ajouter les deux lignes suivantes :</p>
<div class="highlight"><pre><span></span>Host destination.local
    ProxyCommand ssh user@bastion.fr -W %h:%p
</pre></div>


<p>C'est tout.</p>
<p>Explications : on utilise l'host <em>bastion.fr</em> pour se connecter à
<em>destination.local</em>. Quand je tape sur ma machine local <em>ssh
choiz@destination.local</em> mon client SSH lit le fichier de configuration, se
connecte à l'host <em>bastion.fr</em> avec l'utilisateur <em>user</em> puis fait une nouvelle
connexion vers ma destination.</p>
<p>Vous pouvez modifier votre configuration ssh pour se connecter à votre bastion
avec une clé spécifique puis a votre destination avec une autre clé par exemple
ou avec des utilisateurs différents…</p>
<p>Exemple :</p>
<div class="highlight"><pre><span></span>Host bastion.fr
    User toto
    IdentifyFile ~/.ssh/bastion

Host destination.local
    User tata
    IdentifyFile ~/.ssh/destination
</pre></div>


<p>Enjoy vincent.m ;-)</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2017-05-14-docker-commandes-utiles.html">Docker commandes utiles</a></h2>
    <p>
      Posté le dim. 14 mai 2017 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/docker.html">docker</a>,      <a href="//www.choiz.fr/tag/linux.html">linux</a>,      <a href="//www.choiz.fr/tag/container.html">container</a>    </p>
  </header>
  <div>
      <p>Voici quelques commandes très utiles si vous utilisez docker.</p>
<p>Supprimer tous les containers qui sont arétés :</p>
<div class="highlight"><pre><span></span>docker ps -q | xargs docker rm
</pre></div>


<p>Supprimer toutes les images non utilisées :</p>
<div class="highlight"><pre><span></span>docker images -q | xargs docker rmi
</pre></div>


<p>Se connecter a un conteneur docker lancé par son id :</p>
<div class="highlight"><pre><span></span>docker exec -it id_de_votre_container /bin/bash
</pre></div>


<p>Se connecter a un conteneur docker lancé par son nom :</p>
<div class="highlight"><pre><span></span>docker exec -it nom_de_votre_container /bin/bash
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2016-07-30-convertir-un-.deb-en-archive-.tar.gz.html">Convertir un .deb en archive .tar.gz</a></h2>
    <p>
      Posté le sam. 30 juillet 2016 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/deb.html">deb</a>,      <a href="//www.choiz.fr/tag/targz.html">tar.gz</a>,      <a href="//www.choiz.fr/tag/debian.html">debian</a>,      <a href="//www.choiz.fr/tag/ubuntu.html">ubuntu</a>,      <a href="//www.choiz.fr/tag/archive.html">archive</a>,      <a href="//www.choiz.fr/tag/gentoo.html">gentoo</a>,      <a href="//www.choiz.fr/tag/linux.html">linux</a>    </p>
  </header>
  <div>
      <p>En voulant installer le logiciel "slack" sur ma machine gentoo au travail j'ai
trouvé un logiciel plutôt intéressant nommé "deb2targz".</p>
<p>En effet <a href="https://slack.com/downloads">slack</a> ne dispose que des archives ubuntu
en 32 bits, 64 bits et fedora en 64 bits.</p>
<p>deb2targz permet de convertir un fichier ".deb" en archive ".tar.gz".</p>
<p>Si vous êtes sur gentoo installez le via : <code>emerge -a app-arch/deb2targz</code></p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2016-05-21-installation-de-xubuntu-16-04-sur-ASUS-X205TA.html">Installation de xubuntu 16.04 sur ASUS X205TA</a></h2>
    <p>
      Posté le sam. 21 mai 2016 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/xubuntu.html">xubuntu</a>,      <a href="//www.choiz.fr/tag/linux.html">linux</a>,      <a href="//www.choiz.fr/tag/asus-x205ta.html">Asus X205TA</a>,      <a href="//www.choiz.fr/tag/64bits.html">64bits</a>,      <a href="//www.choiz.fr/tag/ubuntu.html">ubuntu</a>    </p>
  </header>
  <div>
      <p>J'ai récement acheté un ASUS X205TA, livré avec Windows
10 (32 bits), un disque SSD de 32Go et 2Go de ram et pour un prix de 210€.</p>
<p>J'ai installé xubuntu 16.04 (64 bits) sur une partition séparée pour garder Windows 10.</p>
<p>L'installation est plutôt complexe car le "bootloader" est en 32bits (je pense
d'ailleurs que c'est pour ça qu'il est livré avec un windows 32bits et non
64bits).</p>
<p>Voici <a href="http://ubuntuforums.org/showthread.php?t=2254322&amp;page=92&amp;p=13474817#post13474817">un message</a> qui explique l'installation simple d'ubuntu (remplacer l'iso
par xubuntu ou autre).</p>
<p>Pour l'instant : la carte son n'est pas reconnue et le pointeur de la souris
disparait suite a la mise en veille… Mis a part ça la machine fonctionne très
bien pour mon utilisation (des petits développements pendant mes trajets maison &lt;-&gt; travail).</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2016-04-28-passage-en-ssl-du-blog.html">Passage en SSL du blog</a></h2>
    <p>
      Posté le jeu. 28 avril 2016 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/blog.html">blog</a>,      <a href="//www.choiz.fr/tag/ssl.html">ssl</a>,      <a href="//www.choiz.fr/tag/https.html">https</a>,      <a href="//www.choiz.fr/tag/github.html">github</a>,      <a href="//www.choiz.fr/tag/page.html">page</a>    </p>
  </header>
  <div>
      <p>J'utilise pelican sur github pour écrire mon blog depuis quelques temps, voir les
articles précédents sur le sujet.</p>
<p>J'ai décidé de passer le blog en https, avec un certificat gratuit let's encrypt.</p>
<p>Pour mettre en place un certificat SSL sur "github page" il faut avoir un serveur web qui
fait reverse proxy. J'utilise donc apache avec la configuration suivante :</p>
<ul>
<li>Un vhost pour "choiz.fr" qui redirige le port 80 de "choiz.fr" vers le 443 de "www.choiz.fr".</li>
<li>Un vhost pour "choiz.fr" qui redirige le port 443 (avec un certificat ssl
valide) de "choiz.fr" vers le 443 de
"www.choiz.fr".</li>
<li>Un vhost pour "www.choiz.fr" qui redirige le port 80 de "www.choiz.fr" vers
le 443 de "www.choiz.fr".</li>
<li>Et un vhost avec le certificat SSL ainsi que le reverse proxy qui fait croire a
github que je tape directement l'url "http://choiz.github.io".</li>
</ul>
<p>Ici la configuration du dernier vhost :</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;IfModule</span> <span class="err">mod_ssl.c</span><span class="nt">&gt;</span>
<span class="nt">&lt;VirtualHost</span> <span class="err">*:443</span><span class="nt">&gt;</span>
    ServerName www.choiz.fr

    SSLProxyEngine On
    ProxyRequests Off
    ProxyPreserveHost Off
    ProxyPass / https://choiz.github.io/
    ProxyPassReverse / https://choiz.github.io/
    ProxyPassReverse / http://choiz.github.io/

    # puis la config du SSL
    SSLEngine On
    SSLCertificateFile …
    SSLCertificateKeyFile …
<span class="nt">&lt;/VirtualHost&gt;</span>
<span class="nt">&lt;/IfModule&gt;</span>
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2015-11-21-mise-a-jour-d-un-kernel-gentoo.html">Mise à jour d'un kernel gentoo</a></h2>
    <p>
      Posté le sam. 21 novembre 2015 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/gentoo.html">gentoo</a>,      <a href="//www.choiz.fr/tag/kernel.html">kernel</a>,      <a href="//www.choiz.fr/tag/upgrade.html">upgrade</a>,      <a href="//www.choiz.fr/tag/noyaux.html">noyaux</a>,      <a href="//www.choiz.fr/tag/linux.html">linux</a>    </p>
  </header>
  <div>
      <p>Étant actuellement sur un noyau en version 4.2.0, ci-dessous la marche a
suivre pour le mettre à jour vers la version : 4.3.0.</p>
<p>Je liste les différents noyaux gentoo disponibles :</p>
<div class="highlight"><pre><span></span>eix sys-kernel/gentoo-sources
</pre></div>


<p>Je télécharge le noyau 4.3.0 :</p>
<div class="highlight"><pre><span></span>emerge -a =sys-kernel/gentoo-sources-4.3.0
</pre></div>


<p>Une fois téléchargé, il faut modifier le lien symbolique /usr/src/linux
grâce à eselect.</p>
<p>J'affiche la liste des noyaux (celui actuellement selectionné est suivi
d'une étoile) :</p>
<div class="highlight"><pre><span></span>eselect kernel list

[1]     linux-4.2.0-gentoo *
[2]     linux-4.3.0-gentoo
</pre></div>


<p>Pour selectionner notre noyau 4.3.0 il faut utiliser :</p>
<div class="highlight"><pre><span></span>eselect kernel set 2
</pre></div>


<p>Maintenant que vous avez selectionné votre noyau, copier le fichier
".config" de votre noyau précédent (pour conserver vos réglages de
compilation) :</p>
<div class="highlight"><pre><span></span>cp /usr/src/linux-4.2.0-gentoo/.config /usr/src/linux
</pre></div>


<p>Puis <a href="http://www.choiz.fr/2015-09-06-compilation-kernel-gentoo.html">compiler votre
kernel</a>.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2015-11-15-configurer-un-serveur-mail.html">Configurer un serveur mail</a></h2>
    <p>
      Posté le dim. 15 novembre 2015 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/mail.html">mail</a>,      <a href="//www.choiz.fr/tag/postfix.html">postfix</a>,      <a href="//www.choiz.fr/tag/dovecot.html">dovecot</a>,      <a href="//www.choiz.fr/tag/dns.html">dns</a>,      <a href="//www.choiz.fr/tag/ssl.html">ssl</a>,      <a href="//www.choiz.fr/tag/rainloop.html">rainloop</a>,      <a href="//www.choiz.fr/tag/webmail.html">webmail</a>    </p>
  </header>
  <div>
      <p>Installation d'un serveur mail complet et à jour sous debian jessie (8.2).</p>
<h2>Configuration des DNS</h2>
<p>Pour commencer nous allons créer des entrées DNS.</p>
<p>Nous créons un MX pour les mails avec une priorité de 1, un sous domaine
"mail" qui pointe vers l'adresse ipv4 de votre serveur, d'un sous
domaine webmail qui pointe sur le sous domaine mail et d'un
enregistrement SPF :</p>
<div class="highlight"><pre><span></span>votredomaine.com.           MX      1   mail.votredomaine.com.
mail.votredomaine.com.      A           ip.v4.du.serveur
webmail.votredomaine.com.   CNAME       mail.votredomaine.com.
votredomain.com.            SPF         &quot;v=spf1 ip4:ip.v4.du.server ~all&quot;
</pre></div>


<h2>Installation des paquets</h2>
<p>Maintenant installons postfix dovecot-imapd et sasl2-bin :</p>
<div class="highlight"><pre><span></span>apt-get install postfix dovecot-imapd sasl2-bin php5-curl
</pre></div>


<p>Configurer le serveur de messagerie comme "Site Internet", puis en nom
de courrier indiquer "mail.votredomaine.com".</p>
<h2>Configuration de dovecot</h2>
<p>Créer un dossier ssl dans dovecot :</p>
<div class="highlight"><pre><span></span>mkdir /etc/dovecot/ssl &amp;&amp; cd /etc/dovecot/ssl
</pre></div>


<p>Créer un certificat ssl :</p>
<div class="highlight"><pre><span></span>openssl req -new -newkey rsa:2048 -nodes -keyout certificat.key -out certificat.csr
</pre></div>


<p>Puis répondre aux différentes questions pour ma part j'ai répondu :</p>
<div class="highlight"><pre><span></span>FR
(vide)
Paris
votredomaine
IT
mail.votredomaine.com
contact@votredomaine.com
(vide)
(vide)
</pre></div>


<p>Ensuite :</p>
<div class="highlight"><pre><span></span>openssl x509 -req -days 365 -in certificat.csr -signkey certificat.key -out certificat.crt
</pre></div>


<p>Puis :</p>
<div class="highlight"><pre><span></span>cat certificat.key certificat.crt &gt; certificat.pem
</pre></div>


<p>Créer le groupe et l'utilisateur vmail :</p>
<div class="highlight"><pre><span></span>groupadd -g 5000 vmail
useradd -m -d /var/vmail -s /bin/false -u 5000 -g vmail vmail
</pre></div>


<p>Ajouter dans /etc/dovecot/dovecot.conf :</p>
<div class="highlight"><pre><span></span>listen = ip.v4.du.server
</pre></div>


<p>Editer /etc/dovecot/conf.d/10-auth.conf :</p>
<div class="highlight"><pre><span></span>disable_plaintext_auth = yes
auth_username_format = %Lu
#!include auth-system.conf.ext
!include auth-passwdfile.conf.ext
</pre></div>


<p>Editer /etc/dovecot/conf.d/10-logging.conf :</p>
<div class="highlight"><pre><span></span>auth_verbose = yes
mail_debug = yes
</pre></div>


<p>Editer /etc/dovecot/conf.d/10-master.conf :</p>
<div class="highlight"><pre><span></span>unix_listener /var/spool/postfix/private/auth {
  mode = 0666
  user = postfix
  group = postfix
}
</pre></div>


<p>Editer /etc/dovecot/conf.d/10-ssl.conf :</p>
<div class="highlight"><pre><span></span>ssl = required
ssl_cert = &lt;/etc/dovecot/ssl/certificat.pem
ssl_key = &lt;/etc/dovecot/ssl/certificat.key
</pre></div>


<p>Editer /etc/dovecot/conf.d/15-mailboxes.conf :</p>
<div class="highlight"><pre><span></span>mailbox Drafts {
    auto = subscribe
    special_use = \Drafts
}

mailbox Junk {
    auto = subscribe
    special_use = \Junk
}

mailbox Trash {
    auto = subscribe
    special_use = \Trash
}

mailbox Sent {
    auto = subscribe
    special_use = \Sent
}

#mailbox &quot;Sent Messages&quot; {
#    special_use = \Sent
#}
</pre></div>


<p>Editer /etc/dovecot/conf.d/auth-passwdfile.conf.ext :</p>
<div class="highlight"><pre><span></span>passdb {
    driver = passwd-file
    args = scheme=MD5 username_format=%u /etc/dovecot/users
}

userdb {
    driver = passwd-file
    args = username_format=%u /etc/dovecot/users
    default_fields = uid=5000 gid=5000 home=/var/vmail/%d mail=maildir:~/%u
}
</pre></div>


<p>Créer le fichier /etc/dovecot/users :</p>
<div class="highlight"><pre><span></span>touch /etc/dovecot/users
</pre></div>


<p>Puis pour chaque mail créer un enregistrement :</p>
<div class="highlight"><pre><span></span>adresse@votredomaine.com:motdepassemd5:::::::
</pre></div>


<p>Le format est le suivant :</p>
<table>
<thead>
<tr class="header">
<th align="left">Champ</th>
<th align="left">Valeur</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Adresse email</td>
<td align="left"><script type="text/javascript">
<!--
h='&#118;&#x6f;&#116;&#114;&#x65;&#100;&#x6f;&#x6d;&#x61;&#x69;&#110;&#x65;&#46;&#x63;&#x6f;&#x6d;';a='&#64;';n='&#x61;&#100;&#114;&#x65;&#x73;&#x73;&#x65;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'" clas'+'s="em' + 'ail">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#x61;&#100;&#114;&#x65;&#x73;&#x73;&#x65;&#32;&#x61;&#116;&#32;&#118;&#x6f;&#116;&#114;&#x65;&#100;&#x6f;&#x6d;&#x61;&#x69;&#110;&#x65;&#32;&#100;&#x6f;&#116;&#32;&#x63;&#x6f;&#x6d;</noscript></td>
</tr>
<tr class="odd">
<td align="left">Mot de passe (MD5)</td>
<td align="left">motdepassemd5</td>
</tr>
<tr class="odd">
<td align="left">uid</td>
<td align="left">déjà défini dans auth-passwdfile</td>
</tr>
<tr class="odd">
<td align="left">gid</td>
<td align="left">déjà défini dans auth-passwdfile</td>
</tr>
<tr class="odd">
<td align="left">home directory</td>
<td align="left">déjà défini dans auth-passwdfile</td>
</tr>
<tr class="odd">
<td align="left">mail directory</td>
<td align="left">déjà défini dans auth-passwdfile</td>
</tr>
</tbody>
</table>

<p>Tester votre utilisateur grâce à la commande :</p>
<div class="highlight"><pre><span></span>doveadm user adresse@votredomaine.com
</pre></div>


<p>Ce qui devrait afficher :</p>
<div class="highlight"><pre><span></span>field   value
uid     5000
gid     5000
home    /var/vmail/votredomaine.com
mail    maildir:~/adresse@votredomaine.com
</pre></div>


<p>Démarrer dovecot :</p>
<div class="highlight"><pre><span></span>/etc/init.d/dovecot start
</pre></div>


<p>Tester la connexion :</p>
<div class="highlight"><pre><span></span>openssl s_client -connect ip.v4.du.server:993
</pre></div>


<p>Si vous avez "* OK [CAPABILITY …] Dovecot ready. Vous pouvez vous
authentifier :</p>
<div class="highlight"><pre><span></span>. LOGIN adresse@votredomaine.com motdepasseenclair
</pre></div>


<p>C'est fini pour dovecot.</p>
<h2>Configuration de sasl</h2>
<p>Editer /etc/default/saslauthd :</p>
<div class="highlight"><pre><span></span>START=yes
OPTIONS=&quot;-m /var/spool/postfix/var/run/saslauthd&quot;
</pre></div>


<p>Puis lancer :</p>
<div class="highlight"><pre><span></span>/etc/init.d/saslauthd start
</pre></div>


<p>C'est fini pour sasl</p>
<h2>Configuration de postfix</h2>
<p>Editer /etc/postfix/main.cf ::</p>
<div class="highlight"><pre><span></span>smtpd_banner = $myhostname ESMTP $mail_name
smtpd_tls_cert_file=/etc/dovecot/ssl/certificat.pem
smtpd_tls_key_file=/etc/dovecot/ssl/certificat.key
mynetworks = 127.0.0.0/8 ip.v4.du.server

virtual_mailbox_domains = votredomaine.com, autredomaine.com
virtual_mailbox_base = /var/vmail
virtual_mailbox_maps = hash:/etc/postfix/virtual_mailbox
virtual_minimum_uid = 100
virtual_uid_maps = static:5000
virtual_gid_maps = static:5000
virtual_alias_maps = hash:/etc/postfix/virtual_alias

smtpd_sasl_auth_enable = yes
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_security_options = noanonymous
smtpd_sasl_tls_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname

broken_sasl_auth_clients = yes

smtpd_helo_restrictions = reject_unknown_helo_hostname
smtpd_sender_restrictions = permit_sasl_authenticated reject_unknown_sender_domain
smtpd_recipient_restrictions = permit_sasl_authenticated permit_mynetworks reject_unauth_destination

smtpd_enforce_tls = no
smtpd_tls_auth_only = no
smtpd_tls_ask_ccert = no
smtpd_tls_received_header = yes
tls_random_source = dev:/dev/urandom
</pre></div>


<p>Créer /etc/postfix/virtual_alias :</p>
<div class="highlight"><pre><span></span>touch /etc/postfix/virtual_alias
</pre></div>


<p>Pour créer un alias, éditer /etc/postfix/virtual_alias :</p>
<div class="highlight"><pre><span></span>alias@votredomaine.com          destination@votredomaine.com
</pre></div>


<p>Créer /etc/postfix/virtual_domains :</p>
<div class="highlight"><pre><span></span>touch /etc/postfix/virtual_domains
</pre></div>


<p>Pour gérer vos domaines, éditer /etc/postfix/virtual_domains :</p>
<div class="highlight"><pre><span></span>votredomaine.com                OK
votredeuxiemedomaine.com        OK
</pre></div>


<p>Créer /etc/postfix/virtual_mailbox :</p>
<div class="highlight"><pre><span></span>touch /etc/postfix/virtual_mailbox
</pre></div>


<p>Pour créer un comte mail, éditer /etc/postfix/virtual_mailbox :</p>
<div class="highlight"><pre><span></span>email@votredomaine.com          votredomaine.com/email@votredomaine.com/
linus@torvald.com               torvald.com/linus@torvald.com/
</pre></div>


<p>N'oubliez pas lors de la création de nouveau comptes mail d'éditer
/etc/dovecot/users ;-)</p>
<p>Maintenant il faut dire a postfix que nous avons modifier nos fichiers
virtuels :</p>
<div class="highlight"><pre><span></span>postmap /etc/postfix/virtual_alias
postmap /etc/postfix/virtual_domains
postmap /etc/postfix/virtual_mailbox
</pre></div>


<p>Editer /etc/postfix/master.cf :</p>
<div class="highlight"><pre><span></span>smtp    inet    n   -   -   -   -   smtpd   -v
 -o smtpd_tls_cert_file=/etc/dovecot/ssl/certificat.pem
 -o smtpd_tls_key_file=/etc/dovecot/ssl/certificat.key
submission inet n - n - - smtpd
 -o smtpd_tls_security_level=encrypt
 -o smtpd_sasl_auth_enable=yes
urd inet n - n - - smtpd
 -o smtpd_tls_wrappermode=yes
 -o smtpd_sasl_auth_enable=yes
smtps   inet    n   -   -   -   -   smtpd   -v
 -o smtpd_tls_wrappermode=yes
 -o smtpd_tls_cert_file=/etc/dovecot/ssl/certificat.pem
 -o smtpd_tls_key_file=/etc/dovecot/ssl/certificat.key
</pre></div>


<p>Puis redemarrer postfix :</p>
<div class="highlight"><pre><span></span>/etc/init.d/postfix restart
</pre></div>


<p>Fin de la configuration de postfix.</p>
<p>Vous pouvez maintenant tester votre serveur mail ainsi que la qualité de
votre serveur sur le site <a href="http://www.mail-tester.com">http://www.mail-tester.com</a></p>
<h2>Installation d'un webmail rainloop</h2>
<p>Créer un dossier pour votre webmail :</p>
<div class="highlight"><pre><span></span>mkdir -p /var/www/webmail/public &amp;&amp; cd /var/www/webmail/public
</pre></div>


<p>Télécharger rainloop :</p>
<div class="highlight"><pre><span></span>wget http://repository.rainloop.net/v2/webmail/rainloop-community-latest.zip
</pre></div>


<p>Décompresser rainloop :</p>
<div class="highlight"><pre><span></span>unzip rainloop*.zip &amp;&amp; rm -rf rainloop*.zip
</pre></div>


<p>Modifier les droits :</p>
<div class="highlight"><pre><span></span>chown -R www-data:www-data /var/www/webmail
find . -type f -exec chmod 644 {} \;
find . -type d -exec chmod 755 {} \;
</pre></div>


<p>Créer un vhost pour apache dans
/etc/apache2/site-enabled/001-webmail.domain.com.conf :</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
    ServerAdmin contact@domain.com
    ServerName mail.domain.com

    DocumentRoot /var/www/webmail/public
    <span class="nt">&lt;Directory</span> <span class="err">/var/www/webmail/public</span><span class="nt">&gt;</span>
        Options FollowSymLinks
        #Options Indexes FollowSymLinks MultiViews
        AllowOverride All
        Order allow,deny
        allow from all
    <span class="nt">&lt;/Directory&gt;</span>

    <span class="nt">&lt;Directory</span> <span class="err">/var/www/webmail/public/data</span><span class="nt">&gt;</span>
        Options -FollowSymLinks
        AllowOverride None
        Order allow,deny
        Deny from all
    <span class="nt">&lt;/Directory&gt;</span>

    ErrorLog <span class="cp">${</span><span class="n">APACHE_LOG_DIR</span><span class="cp">}</span>/webmail_error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    CustomLog <span class="cp">${</span><span class="n">APACHE_LOG_DIR</span><span class="cp">}</span>/webmail_access.log combined
<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>


<p>N'oubliez pas de redémarrer apache :</p>
<div class="highlight"><pre><span></span>/etc/init.d/apache2 restart
</pre></div>


<p>Pour configurer rainloop se rendre sur : <a href="http://mail.domain.com/?admin">http://mail.domain.com/?admin</a></p>
<table>
<thead>
<tr class="header">
<th align="left">Login</th>
<th align="left">admin</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Password</td>
<td align="left">12345</td>
</tr>
</tbody>
</table>

<p>Changer la langue et votre mot de passe (dans security).</p>
<p>Puis dans domains configurez votre nom de domaine en cliquant sur + Add
domain</p>
<table>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">domaine.com</th>
</tr>
</thead>
<tbody>
<tr class="even">
<td align="left">IMAP</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Server</td>
<td align="left">mail.domain.com</td>
</tr>
<tr class="even">
<td align="left">Secure</td>
<td align="left">SSL/TLS</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th align="left">SMTP</th>
<th align="left"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Server</td>
<td align="left">mail.domain.com</td>
</tr>
<tr class="odd">
<td align="left">Secure</td>
<td align="left">SSL/TLS</td>
</tr>
</tbody>
</table>

<p>Puis + Add</p>
<p>Je supprime tous les autres domaines (gmail etc…)</p>
<p>Ensuite j'active les plugins, et les packages : X-Originating-IP, Black
list et White list.</p>
<p>Maintenant rendez-vous sur : <a href="http://mail.domain.com">http://mail.domain.com</a> et identifiez-vous
avec votre login et mot de passe.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="//www.choiz.fr/2015-10-25-gentoo-navigateur-web-par-defaut.html">Gentoo Navigateur Web par Défaut</a></h2>
    <p>
      Posté le dim. 25 octobre 2015 &#8226;
Tags :
      <a href="//www.choiz.fr/tag/gentoo.html">gentoo</a>,      <a href="//www.choiz.fr/tag/web.html">web</a>,      <a href="//www.choiz.fr/tag/browser.html">browser</a>,      <a href="//www.choiz.fr/tag/default.html">default</a>,      <a href="//www.choiz.fr/tag/navigateur.html">navigateur</a>    </p>
  </header>
  <div>
      <p>Sur ma machine "links" était le navigateur web par défaut. Il est
pratique pour lire du texte, dès que l'on a du contenu audio ou vidéo il
est préférable d'utiliser un navigateur tel que Firefox.</p>
<p>Voici la commande pour voir le navigateur par défaut pour les url
utilisants le protocole "http" :</p>
<div class="highlight"><pre><span></span>xdg-mime query default x-scheme-handler/http
</pre></div>


<p>Et voici la commande pour le "https" :</p>
<div class="highlight"><pre><span></span>xdg-mime query default x-scheme-handler/https
</pre></div>


<p>Pour changer le navigateur par défaut par Firefox il suffit d'executer
ses deux commandes :</p>
<div class="highlight"><pre><span></span>xdg-mime default firefox.desktop x-scheme-handler/http
xdg-mime default firefox.desktop x-scheme-handler/https
</pre></div>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="//www.choiz.fr/index3.html">
      <i class="fa fa-angle-left"></i> Anciens articles
    </a>
      <a class="btn float-right" href="//www.choiz.fr/index.html">
        Nouveaux articles <i class="fa fa-angle-right"></i>
      </a>
  </div>

    <footer>
      <p>&copy; François LASSERRE </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/choiz/Flexfork" target="_blank">Flexfork</a> theme by <a href="http://www.choiz.fr">François LASSERRE</a></p>    </footer>
  </main>
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.www.choiz.fr"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//stats.rocketip.net/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '7042kjNK6PYV9LoGM5np']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//stats.rocketip.net/piwik.php?idsite=7042kjNK6PYV9LoGM5np" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code --><script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " ChoiZ ",
  "url" : "//www.choiz.fr",
  "image": "",
  "description": ""
}
</script></body>
</html>